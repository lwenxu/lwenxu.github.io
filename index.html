<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Java SE/Guava Cache 原理分析与最佳实践" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2025/06/07/Java%20SE/Guava%20Cache%20%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="article-date">
  <time datetime="2025-06-07T02:33:12.400Z" itemprop="datePublished">2025-06-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前大部分互联网架构 Cache 已经成为了必可不少的一环。常用的方案有大家熟知的 NoSQL 数据库（Redis、Memcached），也有大量的进程内缓存比如 EhCache 、Guava Cache、Caffeine 等。</p>
<p>本系列文章会选取本地缓存和分布式缓存（NoSQL）的优秀框架比较他们各自的优缺点、应用场景、项目中的最佳实践以及原理分析。本文主要针对本地 Cache 的老大哥 Guava Cache 进行介绍和分析。</p>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><p>Guava Cache 通过简单好用的 Client 可以快速构造出符合需求的 Cache 对象，不需要过多复杂的配置，大多数情况就像构造一个 POJO 一样的简单。这里介绍两种构造 Cache 对象的方式：<code>CacheLoader</code> 和 <code>Callable</code></p>
<h3 id="CacheLoader"><a href="#CacheLoader" class="headerlink" title="CacheLoader"></a>CacheLoader</h3><p>构造 LoadingCache 的关键在于实现 load 方法，也就是在需要 <strong>访问的缓存项不存在的时候 Cache 会自动调用 load 方法将数据加载到 Cache 中</strong>。这里你肯定会想假如有多个线程过来访问这个不存在的缓存项怎么办，也就是缓存的并发问题如何怎么处理是否需要人工介入，这些在下文中也会介绍到。</p>
<p>除了实现 load 方法之外还可以配置缓存相关的一些性质，比如过期加载策略、刷新策略 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LoadingCache&lt;String, String&gt; CACHE = CacheBuilder</span><br><span class="line">	.newBuilder()</span><br><span class="line">    <span class="comment">// 最大容量为 100 超过容量有对应的淘汰机制，下文详述</span></span><br><span class="line">    .maximumSize(<span class="number">100</span>)</span><br><span class="line">    <span class="comment">// 缓存项写入后多久过期，下文详述</span></span><br><span class="line">    .expireAfterWrite(<span class="number">60</span> * <span class="number">5</span>, TimeUnit.SECONDS)</span><br><span class="line">    <span class="comment">// 缓存写入后多久自动刷新一次，下文详述</span></span><br><span class="line">    .refreshAfterWrite(<span class="number">60</span>, TimeUnit.SECONDS)</span><br><span class="line">    <span class="comment">// 创建一个 CacheLoader，load 表示缓存不存在的时候加载到缓存并返回</span></span><br><span class="line">    .build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="comment">// 加载缓存数据的方法</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;cache [&quot;</span> + key + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getTest</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    CACHE.get(<span class="string">&quot;KEY_25487&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>


<h3 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h3><br>


<p>除了在构造 Cache 对象的时候指定 load 方法来加载缓存外，我们亦可以在<strong>获取缓存项时指定载入缓存的方法</strong>，并且可以根据使用场景在不同的位置采用不同的加载方式。</p>
<p>比如在某些位置可以通过二级缓存加载不存在的缓存项，而有些位置则可以直接从 DB 加载缓存项。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 注意返回值是 Cache</span><br><span class="line">private static final Cache&lt;String, String&gt; SIMPLE_CACHE &#x3D; CacheBuilder</span><br><span class="line">	.newBuilder()</span><br><span class="line">    .build();</span><br><span class="line"></span><br><span class="line">public void getTest1() throws Exception &#123;</span><br><span class="line">    String key &#x3D; &quot;KEY_25487&quot;;</span><br><span class="line">    &#x2F;&#x2F; get 缓存项的时候指定 callable 加载缓存项</span><br><span class="line">    SIMPLE_CACHE.get(key, () -&gt; &quot;cache [&quot; + key + &quot;]&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="缓存项加载机制"><a href="#缓存项加载机制" class="headerlink" title="缓存项加载机制"></a>缓存项加载机制</h2><br>


<p>如果某个缓存过期了或者缓存项不存在于缓存中，而恰巧此此时有大量请求过来请求这个缓存项，如果没有保护机制就会导致<strong>大量的线程同时请求数据源加载数据并生成缓存项，这就是所谓的 “缓存击穿”</strong> 。</p>
<p>举个简单的例子，某个时刻有 100 个请求同时请求 KEY_25487 这个缓存项，而不巧这个缓存项刚好失效了，那么这 100 个线程（如果有这么多机器和流量的话）就会同时从 DB 加载这个数据，很可怕的点在于就算某一个线程率先获取到数据生成了缓存项，<strong>其他的线程还是继续请求 DB 而不会走到缓存</strong>。</p>
<div align="center">

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1b46a9835ce84183a5296319eed59e84~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>【缓存击穿图例】</p>
</div>
<br>

<p>看到上面这个图或许你已经有方法解这个问题了，如果多个线程过来如果我们 <strong>只让一个线程去加载数据生成缓存项，其他线程等待然后读取生成好的缓存项</strong> 岂不是就完美解决。那么恭喜你在这个问题上，和 Google 工程师的思路是一致的。不过采用这个方案，问题是解了但没有完全解，后面会说到它的缺陷。</p>
<p>其实 Guava Cache 在 load 的时候做了并发控制，在多个线程请求一个不存在或者过期的缓存项时保证只有一个线程进入 load 方法，其他线程等待直到缓存项被生成，这样就避免了大量的线程击穿缓存直达 DB 。不过试想下如果有上万 QPS 同时过来会有<strong>大量的线程阻塞导致线程无法释放，甚至会出现线程池满的尴尬场景，这也是说为什么这个方案解了 “缓存击穿” 问题但又没完全解。</strong></p>
<p>上述机制其实就是 <code>expireAfterWrite/expireAfterAccess</code> 来控制的，如果你配置了过期策略对应的缓存项在过期后被访问就会走上述流程来加载缓存项。</p>
<h2 id="缓存项刷新机制"><a href="#缓存项刷新机制" class="headerlink" title="缓存项刷新机制"></a>缓存项刷新机制</h2><br>

<p>缓存项的刷新和加载看起来是相似的，都是让缓存数据处于最新的状态。区别在于：</p>
<ul>
<li><strong>缓存项加载是一个被动</strong> 的过程，而 <strong>缓存刷新是一个主动触发</strong> 动作。如果缓存项不存在或者过期只有下次 get 的时候才会触发新值加载。而缓存刷新则更加主动替换缓存中的老值。</li>
<li>另外一个很重要点的在于，<strong>缓存刷新的项目一定是存在缓存中</strong> 的，他是对老值的替换而非是对 NULL 值的替换。</li>
</ul>
<p>由于缓存项刷新的前提是该缓存项存在于缓存中，那么缓存的刷新就不用像缓存加载的流程一样让其他线程等待而是允许一个线程去数据源获取数据，<strong>其他线程都先返回老值直到异步线程生成了新缓存项</strong>。</p>
<p>这个方案完美解决了上述遇到的 “缓存击穿” 问题，不过 <strong>他的前提是已经生成缓存项了</strong> 。在实际生产情况下我们可以做 <strong>缓存预热</strong> ，提前生成缓存项，避免流量洪峰造成的线程堆积。</p>
<p>这套机制在 Guava Cache 中是通过 <code>refreshAfterWrite</code> 实现的，在配置刷新策略后，对应的缓存项会按照设定的时间定时刷新，避免线程阻塞的同时保证缓存项处于最新状态。</p>
<p>但他也不是完美的，比如他的限制是缓存项已经生成，并且 <strong>如果恰巧你运气不好，大量的缓存项同时需要刷新或者过期， 就会有大量的线程请求 DB，这就是常说的 “缓存血崩”</strong> 。</p>
<h2 id="缓存项异步刷新机制"><a href="#缓存项异步刷新机制" class="headerlink" title="缓存项异步刷新机制"></a>缓存项异步刷新机制</h2><br>


<p>上面说到缓存项大面积失效或者刷新会导致雪崩，那么就只能限制访问 DB 的数量了，位置有三个地方：</p>
<ol>
<li><p>源头：因为加载缓存的线程就是前台请求线程，所以如果 <strong>控制请求线程数量</strong> 的确是减少大面积失效对 DB 的请求，那这样一来就不存在高并发请求，就算不用缓存都可以。</p>
</li>
<li><p>中间层缓冲：因为请求线程和访问 DB 的线程是同一个，假如在 <strong>中间加一层缓冲，通过一个后台线程池去异步刷新缓存</strong> 所有请求线程直接返回老值，这样对于 DB 的访问的流量就可以被后台线程池的池大小控住。</p>
</li>
<li><p>底层：直接 <strong>控 DB 连接池的池大小</strong>，这样访问 DB 的连接数自然就少了，但是如果大量请求到连接池发现获取不到连接程序一样会出现连接池满的问题，会有大量连接被拒绝的异常。</p>
</li>
</ol>
<p>所以比较合适的方式是通过添加一个异步线程池异步刷新数据，<strong>在 Guava Cache 中实现方案是重写</strong> <strong>CacheLoader 的 reload 方法</strong> 。</p>
<br>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LoadingCache&lt;String, String&gt; ASYNC_CACHE = CacheBuilder.newBuilder()</span><br><span class="line">    .build(</span><br><span class="line">    CacheLoader.asyncReloading(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> key;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ListenableFuture&lt;String&gt; <span class="title">reload</span><span class="params">(String key, String oldValue)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.reload(key, oldValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">5</span>, Integer.MAX_VALUE,</span><br><span class="line">                              <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                              <span class="keyword">new</span> SynchronousQueue&lt;&gt;()))</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h2 id="LocalCache-源码分析"><a href="#LocalCache-源码分析" class="headerlink" title="LocalCache 源码分析"></a>LocalCache 源码分析</h2><br>

<p>先整体看下 Cache 的类结构，下面的这些子类表示了不同的创建方式本质还都是 LocalCache<br><br></p>
<div align="center">

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f8efc0a4b2084340aab1b26aef7fe76c~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>【Cache 类图】</p>
</div>

<p>核心代码都在 LocalCache 这个文件中，并且通过这个继承关系可以看出 Guava Cache 的本质就是 ConcurrentMap。</p>
<div align="center">

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1cd5441209f1448c805981d463c0b6d9~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>【LocalCache 继承与实现】</p>
</div>



<p>在看源码之前先理一下流程，先理清思路。如果想直接看源码理解流程可以先跳过这张图 ~</p>
<div align="center">

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/de71dd2c50f440779018dd041adfae02~tplv-k3u1fbpfcp-zoom-1.image"></p>
<p>【 get 缓存数据流程图】</p>
</div>


<p>这里核心理一下 Get 的流程，put 阶段比较简单就不做分析了。</p>
<h3 id="LocalCache-get"><a href="#LocalCache-get" class="headerlink" title="LocalCache#get"></a>LocalCache#get</h3><br>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V <span class="title">get</span><span class="params">(K key, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> hash = hash(checkNotNull(key));</span><br><span class="line">    <span class="comment">// 根据 hash 获取对应的 segment 然后从 segment 获取具体值</span></span><br><span class="line">    <span class="keyword">return</span> segmentFor(hash).get(key, hash, loader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Segment-get"><a href="#Segment-get" class="headerlink" title="Segment#get"></a>Segment#get</h3><br>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V <span class="title">get</span><span class="params">(K key, <span class="keyword">int</span> hash, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    checkNotNull(key);</span><br><span class="line">    checkNotNull(loader);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// count 表示在这个 segment 中存活的项目个数</span></span><br><span class="line">        <span class="keyword">if</span> (count != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// 获取 segment 中的元素 (ReferenceEntry) 包含正在 load 的数据</span></span><br><span class="line">            ReferenceEntry&lt;K, V&gt; e = getEntry(key, hash);</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> now = map.ticker.read();</span><br><span class="line">                <span class="comment">// 获取缓存值，如果是 load，invalid，expired 返回 null，同时检查是否过期了,过期移除并返回 null</span></span><br><span class="line">                V value = getLiveValue(e, now);</span><br><span class="line">                <span class="keyword">if</span> (value != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 记录访问时间</span></span><br><span class="line">                    recordRead(e, now);</span><br><span class="line">                    <span class="comment">// 记录缓存命中一次</span></span><br><span class="line">                    statsCounter.recordHits(<span class="number">1</span>);</span><br><span class="line">                    <span class="comment">// 刷新缓存并返回缓存值 ，后面展开</span></span><br><span class="line">                    <span class="keyword">return</span> scheduleRefresh(e, key, hash, value, now, loader);</span><br><span class="line">                &#125;</span><br><span class="line">                ValueReference&lt;K, V&gt; valueReference = e.getValueReference();</span><br><span class="line">                <span class="comment">// 如果在 loading 等着 ，后面展开</span></span><br><span class="line">                <span class="keyword">if</span> (valueReference.isLoading()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> waitForLoadingValue(e, key, valueReference);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 走到这说明从来没写入过值 或者 值为 null 或者 过期（数据还没做清理），后面展开</span></span><br><span class="line">        <span class="keyword">return</span> lockedGetOrLoad(key, hash, loader);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException ee) &#123;</span><br><span class="line">        Throwable cause = ee.getCause();</span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionError((Error) cause);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UncheckedExecutionException(cause);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> ee;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        postReadCleanup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Segment-scheduleRefresh"><a href="#Segment-scheduleRefresh" class="headerlink" title="Segment#scheduleRefresh"></a>Segment#scheduleRefresh</h3><br>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// com.google.common.cache.LocalCache.Segment#scheduleRefresh</span></span><br><span class="line"></span><br><span class="line"><span class="function">V <span class="title">scheduleRefresh</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    ReferenceEntry&lt;K, V&gt; entry,</span></span></span><br><span class="line"><span class="function"><span class="params">    K key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">int</span> hash,</span></span></span><br><span class="line"><span class="function"><span class="params">    V oldValue,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">long</span> now,</span></span></span><br><span class="line"><span class="function"><span class="params">    CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">        <span class="comment">// 配置了刷新策略 refreshAfterWrite</span></span><br><span class="line">        map.refreshes()</span><br><span class="line">        <span class="comment">// 到刷新时间了</span></span><br><span class="line">        &amp;&amp; (now - entry.getWriteTime() &gt; map.refreshNanos)</span><br><span class="line">        <span class="comment">// 没在 loading</span></span><br><span class="line">        &amp;&amp; !entry.getValueReference().isLoading()) &#123;</span><br><span class="line">        <span class="comment">// 开始刷新，下面展开</span></span><br><span class="line">        V newValue = refresh(key, hash, loader, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (newValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> newValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> oldValue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// com.google.common.cache.LocalCache.Segment#refresh</span></span><br><span class="line"></span><br><span class="line"><span class="function">V <span class="title">refresh</span><span class="params">(K key, <span class="keyword">int</span> hash, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader, <span class="keyword">boolean</span> checkTime)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 插入 loading 节点</span></span><br><span class="line">    <span class="keyword">final</span> LoadingValueReference&lt;K, V&gt; loadingValueReference =</span><br><span class="line">        insertLoadingValueReference(key, hash, checkTime);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (loadingValueReference == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步刷新，下面展开</span></span><br><span class="line">    ListenableFuture&lt;V&gt; result = loadAsync(key, hash, loadingValueReference, loader);</span><br><span class="line">    <span class="keyword">if</span> (result.isDone()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Uninterruptibles.getUninterruptibly(result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="comment">// don&#x27;t let refresh exceptions propagate; error was already logged</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.google.common.cache.LocalCache.Segment#loadAsync</span></span><br><span class="line"></span><br><span class="line"><span class="function">ListenableFuture&lt;V&gt; <span class="title">loadAsync</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> K key,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> <span class="keyword">int</span> hash,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">final</span> LoadingValueReference&lt;K, V&gt; loadingValueReference,</span></span></span><br><span class="line"><span class="function"><span class="params">    CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过 loader 异步加载数据，下面展开</span></span><br><span class="line">    <span class="keyword">final</span> ListenableFuture&lt;V&gt; loadingFuture = loadingValueReference.loadFuture(key, loader);</span><br><span class="line">    loadingFuture.addListener(</span><br><span class="line">        <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    getAndRecordStats(key, hash, loadingValueReference, loadingFuture);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    logger.log(Level.WARNING, <span class="string">&quot;Exception thrown during refresh&quot;</span>, t);</span><br><span class="line">                    loadingValueReference.setException(t);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        directExecutor());</span><br><span class="line">    <span class="keyword">return</span> loadingFuture;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.google.common.cache.LocalCache.LoadingValueReference#loadFuture</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ListenableFuture&lt;V&gt; <span class="title">loadFuture</span><span class="params">(K key, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        stopwatch.start();</span><br><span class="line">        <span class="comment">// oldValue 指在写入 loading 节点前这个位置的值，如果这个位置之前没有值 oldValue 会被赋值为 UNSET</span></span><br><span class="line">        <span class="comment">// UNSET.get() 值为 null ，所以这个缓存项从来没有进入缓存需要同步 load 具体原因前面提到了，如果通过</span></span><br><span class="line">        <span class="comment">// 异步 reload ，由于没有老值会导致其他线程返回的都是 null</span></span><br><span class="line">        V previousValue = oldValue.get();</span><br><span class="line">        <span class="keyword">if</span> (previousValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            V newValue = loader.load(key);</span><br><span class="line">            <span class="keyword">return</span> set(newValue) ? futureValue : Futures.immediateFuture(newValue);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 异步 load</span></span><br><span class="line">        ListenableFuture&lt;V&gt; newValue = loader.reload(key, previousValue);</span><br><span class="line">        <span class="keyword">if</span> (newValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Futures.immediateFuture(<span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// To avoid a race, make sure the refreshed value is set into loadingValueReference</span></span><br><span class="line">        <span class="comment">// *before* returning newValue from the cache query.</span></span><br><span class="line">        <span class="keyword">return</span> transform(</span><br><span class="line">            newValue,</span><br><span class="line">            <span class="keyword">new</span> com.google.common.base.Function&lt;V, V&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> V <span class="title">apply</span><span class="params">(V newValue)</span> </span>&#123;</span><br><span class="line">                    LoadingValueReference.<span class="keyword">this</span>.set(newValue);</span><br><span class="line">                    <span class="keyword">return</span> newValue;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            directExecutor());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        ListenableFuture&lt;V&gt; result = setException(t) ? futureValue : fullyFailedFuture(t);</span><br><span class="line">        <span class="keyword">if</span> (t <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Segment-waitForLoadingValue"><a href="#Segment-waitForLoadingValue" class="headerlink" title="Segment#waitForLoadingValue"></a>Segment#waitForLoadingValue</h3><br>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V <span class="title">waitForLoadingValue</span><span class="params">(ReferenceEntry&lt;K, V&gt; e, K key, ValueReference&lt;K, V&gt; valueReference)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    <span class="comment">// 首先你要是一个 loading 节点</span></span><br><span class="line">    <span class="keyword">if</span> (!valueReference.isLoading()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    checkState(!Thread.holdsLock(e), <span class="string">&quot;Recursive load of: %s&quot;</span>, key);</span><br><span class="line">    <span class="comment">// don&#x27;t consider expiration as we&#x27;re concurrent with loading</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        V value = valueReference.waitForValue();</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidCacheLoadException(<span class="string">&quot;CacheLoader returned null for key &quot;</span> + key + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// re-read ticker now that loading has completed</span></span><br><span class="line">        <span class="keyword">long</span> now = map.ticker.read();</span><br><span class="line">        recordRead(e, now);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        statsCounter.recordMisses(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.google.common.cache.LocalCache.LoadingValueReference#waitForValue</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">waitForValue</span><span class="params">()</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getUninterruptibly(futureValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.google.common.util.concurrent.Uninterruptibles#getUninterruptibly</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;V&gt; <span class="function">V <span class="title">getUninterruptibly</span><span class="params">(Future&lt;V&gt; future)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// hang 住，如果该线程被打断了继续回去 hang 住等结果，直到有结果返回</span></span><br><span class="line">                <span class="keyword">return</span> future.get();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Segment-lockedGetOrLoad"><a href="#Segment-lockedGetOrLoad" class="headerlink" title="Segment#lockedGetOrLoad"></a>Segment#lockedGetOrLoad</h3><br>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">V <span class="title">lockedGetOrLoad</span><span class="params">(K key, <span class="keyword">int</span> hash, CacheLoader&lt;? <span class="keyword">super</span> K, V&gt; loader)</span> <span class="keyword">throws</span> ExecutionException </span>&#123;</span><br><span class="line">    ReferenceEntry&lt;K, V&gt; e;</span><br><span class="line">    ValueReference&lt;K, V&gt; valueReference = <span class="keyword">null</span>;</span><br><span class="line">    LoadingValueReference&lt;K, V&gt; loadingValueReference = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> createNewEntry = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 要对 segment 写操作 ，先加锁</span></span><br><span class="line">    lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// re-read ticker once inside the lock</span></span><br><span class="line">        <span class="keyword">long</span> now = map.ticker.read();</span><br><span class="line">        preWriteCleanup(now);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里基本就是 HashMap 的代码，如果没有 segment 的数组下标冲突了就拉一个链表</span></span><br><span class="line">        <span class="keyword">int</span> newCount = <span class="keyword">this</span>.count - <span class="number">1</span>;</span><br><span class="line">        AtomicReferenceArray&lt;ReferenceEntry&lt;K, V&gt;&gt; table = <span class="keyword">this</span>.table;</span><br><span class="line">        <span class="keyword">int</span> index = hash &amp; (table.length() - <span class="number">1</span>);</span><br><span class="line">        ReferenceEntry&lt;K, V&gt; first = table.get(index);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (e = first; e != <span class="keyword">null</span>; e = e.getNext()) &#123;</span><br><span class="line">            K entryKey = e.getKey();</span><br><span class="line">            <span class="keyword">if</span> (e.getHash() == hash</span><br><span class="line">                &amp;&amp; entryKey != <span class="keyword">null</span></span><br><span class="line">                &amp;&amp; map.keyEquivalence.equivalent(key, entryKey)) &#123;</span><br><span class="line">                valueReference = e.getValueReference();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果在加载中 不做任何处理</span></span><br><span class="line">                <span class="keyword">if</span> (valueReference.isLoading()) &#123;</span><br><span class="line">                    createNewEntry = <span class="keyword">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    V value = valueReference.get();</span><br><span class="line">                    <span class="comment">// 如果缓存项为 null 数据已经被删除，通知对应的 queue </span></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        enqueueNotification(</span><br><span class="line">                            entryKey, hash, value, valueReference.getWeight(), RemovalCause.COLLECTED);</span><br><span class="line">                    <span class="comment">// 这个是 double check 如果缓存项过期 数据没被删除，通知对应的 queue </span></span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (map.isExpired(e, now)) &#123;</span><br><span class="line">                        <span class="comment">// This is a duplicate check, as preWriteCleanup already purged expired</span></span><br><span class="line">                        <span class="comment">// entries, but let&#x27;s accommodate an incorrect expiration queue.</span></span><br><span class="line">                        enqueueNotification(</span><br><span class="line">                            entryKey, hash, value, valueReference.getWeight(), RemovalCause.EXPIRED);</span><br><span class="line">                    <span class="comment">// 再次看到的时候这个位置有值了直接返回 </span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        recordLockedRead(e, now);</span><br><span class="line">                        statsCounter.recordHits(<span class="number">1</span>);</span><br><span class="line">                        <span class="keyword">return</span> value;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// immediately reuse invalid entries</span></span><br><span class="line">                    writeQueue.remove(e);</span><br><span class="line">                    accessQueue.remove(e);</span><br><span class="line">                    <span class="keyword">this</span>.count = newCount; <span class="comment">// write-volatile</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 没有 loading ，创建一个 loading 节点</span></span><br><span class="line">        <span class="keyword">if</span> (createNewEntry) &#123;</span><br><span class="line">            loadingValueReference = <span class="keyword">new</span> LoadingValueReference&lt;&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">                e = newEntry(key, hash, first);</span><br><span class="line">                e.setValueReference(loadingValueReference);</span><br><span class="line">                table.set(index, e);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                e.setValueReference(loadingValueReference);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        unlock();</span><br><span class="line">        postWriteCleanup();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (createNewEntry) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Synchronizes on the entry to allow failing fast when a recursive load is</span></span><br><span class="line">            <span class="comment">// detected. This may be circumvented when an entry is copied, but will fail fast most</span></span><br><span class="line">            <span class="comment">// of the time.</span></span><br><span class="line">            <span class="keyword">synchronized</span> (e) &#123;</span><br><span class="line">                <span class="keyword">return</span> loadSync(key, hash, loadingValueReference, loader);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            statsCounter.recordMisses(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// The entry already exists. Wait for loading.</span></span><br><span class="line">        <span class="keyword">return</span> waitForLoadingValue(e, key, valueReference);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><br>


<p>结合上面图以及源码我们发现在整个流程中 GuavaCache 是<strong>没有额外的线程去做数据清理和刷新的，基本都是通过 Get 方法来触发这些动作</strong> ，减少了设计的复杂性和降低了系统开销。</p>
<p>简单回顾下 Get 的流程以及在每个阶段做的事情，返回的值。<strong>首先判断缓存是否过期然后判断是否需要刷新，如果过期了就调用 loading 去同步加载数据（其他线程阻塞），如果是仅仅需要刷新调用 reloading 异步加载（其他线程返回老值）。</strong></p>
<p>所以如果 refreshTime &gt; expireTime 意味着永远走不到缓存刷新逻辑，缓存刷新是为了在缓存有效期内尽量保证缓存数据一致性所以在配置刷新策略和过期策略时一定保证 refreshTime &lt; expireTime 。</p>
<p>最后关于 Guava Cache 的使用建议 (最佳实践) ：</p>
<ol>
<li>如果刷新时间配置的较短一定要重载 reload 异步加载数据的方法，传入一个自定义线程池保护 DB</li>
<li>失效时间一定要大于刷新时间</li>
<li>如果是常驻内存的一些少量数据失效时间可以配置的较长刷新时间配置短一点 (根据业务对缓存失效容忍度)</li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/06/07/Java%20SE/Guava%20Cache%20%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" data-id="cmblme3cx00ptlppve0ho170y" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/SpringFu DSL 设计思想" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/11/Spring/SpringFu%20DSL%20%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/" class="article-date">
  <time datetime="2021-07-11T15:02:37.000Z" itemprop="datePublished">2021-07-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringFu/">SpringFu</a>►<a class="article-category-link" href="/categories/SpringFu/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/11/Spring/SpringFu%20DSL%20%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/">SpringFu DSL 设计思想</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>让我们再回头看看这个启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JafuApplication app = Jafu.webApplication(ioc -&gt;</span><br><span class="line">            ioc.beans(beanDefinition -&gt;</span><br><span class="line">                    beanDefinition.bean(SampleHandler.class)</span><br><span class="line">                            .bean(SampleService.class)</span><br><span class="line">                            .bean(Sample.class)</span><br><span class="line">            ).enable(WebMvcServerDsl.webMvc(dsl -&gt;</span><br><span class="line">                    dsl.port(dsl.profiles().contains(<span class="string">&quot;test&quot;</span>) ? <span class="number">8181</span> : <span class="number">8080</span>)</span><br><span class="line">                            .router(router -&gt; &#123;</span><br><span class="line">                                SampleHandler handler = dsl.ref(SampleHandler.class);</span><br><span class="line">                                router.GET(<span class="string">&quot;/sayHello&quot;</span>, handler::hello);</span><br><span class="line">                            &#125;)</span><br><span class="line">                            .converters(c -&gt;</span><br><span class="line">                                    c.string().jackson()</span><br><span class="line">                            )</span><br><span class="line">            ))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        ConfigurableApplicationContext context = app.run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>从上面的代码中可以看到，不论是 <code>Jafu.webApplication</code> 还是 <code>ConfigurationDsl.enable()</code> 或者 <code>WebMvcServerDsl.webMvc()</code> 他们都有一个共同的特点就是通过 DSL 来描述设置、加载配置、定义 Bean ，可以说 <code>DSL</code> 就是整个 SpringFu 的驱动器和灵魂。</p>
<p>那么对于这些 DSL 又究竟是什么，里面都有哪些神奇的小组件，DSL 之间又有哪些使用小技巧呢？带着这些问题可以一起来扒一扒 SpringFu 的源码。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710194145037.png" alt="image-20210710194145037"></p>
<p>看到上面这个图一切就明朗起来了，如果说 SpringBoot 的自动配置是通过 <code>xxxAutoConfiguration</code> 那么SpringFu 的核心就在于 <code>xxxDsl</code> 。是的他将所有的组件都通过一份 <code>DSL代码</code>  来做配置和组合。而 DSL 的本质其实是 <code>ApplicationContextInitializer</code> 如果你恰好也熟悉 SpringBoot 的自动配置原理的话，你会顿时明白他们本质是同一个东西，都是通过 <code>ApplicationContextInitializer</code> 这个钩子函数来魔改 Spring 定义框架行为的。</p>
<p>如果你还不太熟悉 <code>ApplicationContextInitializer</code> 可以参看我写的这篇文章：xxx ，浅显易懂的介绍了他是什么，怎么用，为什么这么用。</p>
<h2 id="顶级-Dsl"><a href="#顶级-Dsl" class="headerlink" title="顶级 Dsl"></a>顶级 Dsl</h2><p>​    这里说的顶级 Dsl 并不是指他在类层级上属于顶层，而是说他是用于配置一个 SpringBoot 应用的 Dsl ，要启动一个 SpringBoot 应用首先要定义这个 Dsl。</p>
<p>​    这个类的代码也是非常简单，核心功能点在于执行用户自定义的 DslFunction。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationDsl</span> <span class="keyword">extends</span> <span class="title">ConfigurationDsl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Consumer&lt;ApplicationDsl&gt; dsl;</span><br><span class="line"></span><br><span class="line">	ApplicationDsl(Consumer&lt;ApplicationDsl&gt; dsl) &#123;</span><br><span class="line">		<span class="keyword">super</span>(configurationDsl -&gt; &#123;&#125;);</span><br><span class="line">		<span class="keyword">this</span>.dsl = dsl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(GenericApplicationContext context)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.initialize(context);</span><br><span class="line">		<span class="keyword">this</span>.dsl.accept(<span class="keyword">this</span>); <span class="comment">// 执行自定义 DSL</span></span><br><span class="line">		<span class="keyword">new</span> MessageSourceInitializer().initialize(context); <span class="comment">// 注册国际化的 AutoConfigurationBean </span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>追溯下 <code>ApplicationDsl</code> 的父类 <code>ConfigurationDsl</code> 看起来方法不少，但要注意一个点我们可以把所有的 Dsl 类都分为两部分：<code>配置</code> 和 <code>执行</code> 。配置即组装当前 Dsl 的上下文，执行则是根据前面组装的上下文执行 initialize 方法。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710200135821.png" alt="image-20210710200135821"></p>
<p>​        上图两个红框的部分，分别是 <code>提供给用户的配置方法</code> 和 <code>系统执行的初始化方法</code> 。核心方法如下：</p>
<h3 id="logging"><a href="#logging" class="headerlink" title="logging"></a>logging</h3><p>​    配置日志等级</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurationDsl <span class="title">logging</span><span class="params">(Consumer&lt;LoggingDsl&gt; dsl)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">new</span> LoggingDsl(dsl);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="configurationProperties"><a href="#configurationProperties" class="headerlink" title="configurationProperties"></a>configurationProperties</h3><p>使用配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">ConfigurationDsl <span class="title">configurationProperties</span><span class="params">(Class&lt;T&gt; clazz, String prefix)</span> </span>&#123;</span><br><span class="line">   context.registerBean(clazz.getSimpleName() + <span class="string">&quot;ConfigurationProperties&quot;</span>, clazz, () -&gt; <span class="keyword">new</span> FunctionalConfigurationPropertiesBinder(context).bind(prefix, Bindable.of(clazz)).get());</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="beans"><a href="#beans" class="headerlink" title="beans"></a>beans</h3><p>注册 bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurationDsl <span class="title">beans</span><span class="params">(Consumer&lt;BeanDefinitionDsl&gt; dsl)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">new</span> BeanDefinitionDsl(dsl).initialize(context);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="enable"><a href="#enable" class="headerlink" title="enable"></a>enable</h3><p>​    立即执行某个具体的 <code>Dsl</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> ConfigurationDsl <span class="title">enable</span><span class="params">(ApplicationContextInitializer&lt;GenericApplicationContext&gt; configuration)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> (ConfigurationDsl) <span class="keyword">super</span>.enable(configuration);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AbstractDsl <span class="title">enable</span><span class="params">(ApplicationContextInitializer&lt;GenericApplicationContext&gt; dsl)</span> </span>&#123;</span><br><span class="line">  dsl.initialize(context);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时他还有一个重载的方法，立即执行 <code>ConfigurationDsl</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurationDsl <span class="title">enable</span><span class="params">(Consumer&lt;ConfigurationDsl&gt; configuration)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">new</span> ConfigurationDsl(configuration).initialize(context);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h3><p>添加监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E extends ApplicationEvent&gt; <span class="function">ConfigurationDsl <span class="title">listener</span><span class="params">(Class&lt;E&gt; clazz, ApplicationListener&lt;E&gt; listener)</span> </span>&#123;</span><br><span class="line">   context.addApplicationListener(e -&gt; &#123;</span><br><span class="line">      <span class="comment">// TODO Leverage SPR-16872 when it will be fixed</span></span><br><span class="line">      <span class="keyword">if</span> (clazz.isAssignableFrom(e.getClass())) &#123;</span><br><span class="line">         listener.onApplicationEvent((E)e);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;);</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在追溯 <code>ConfigurationDsl</code> 的父类 <code>AbstractDsl</code> 可以看到他提供了几个获取 Bean 以及获取环境变量的方法提供给所有的 Dsl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDsl</span> <span class="keyword">implements</span> <span class="title">ApplicationContextInitializer</span>&lt;<span class="title">GenericApplicationContext</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> GenericApplicationContext context;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">ref</span><span class="params">(Class&lt;T&gt; beanClass)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.context.getBean(beanClass);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">ref</span><span class="params">(Class&lt;T&gt; beanClass, String name)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.context.getBean(name, beanClass);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Environment <span class="title">env</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> context.getEnvironment();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">profiles</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> Arrays.asList(context.getEnvironment().getActiveProfiles());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">protected</span> AbstractDsl <span class="title">enable</span><span class="params">(ApplicationContextInitializer&lt;GenericApplicationContext&gt; dsl)</span> </span>&#123;</span><br><span class="line">      dsl.initialize(context);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">   &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">(GenericApplicationContext context)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.context = context;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DSL-设计思路"><a href="#DSL-设计思路" class="headerlink" title="DSL 设计思路"></a>DSL 设计思路</h2><p>​        看了一个顶级 Dsl 的源码后我们大致能够窥探到整个 SpringFu 的 Dsl 的设计思路了：<code>执行 xx 操作就返回 xxDsl，并且在执行 xx 操作时传递 xxDsl 中预置方法的组合，来定义这个 Dsl 的行为。</code> 看文字还是比较抽象的，结合一个例子和图就会很明白了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">WebMvcServerDsl webDsl = WebMvcServerDsl.webMvc(dsl -&gt;</span><br><span class="line">                            dsl.port(dsl.profiles().contains(<span class="string">&quot;test&quot;</span>) ? <span class="number">8181</span> : <span class="number">8080</span>)</span><br><span class="line">                                .router(router -&gt; &#123;</span><br><span class="line">                                    SampleHandler handler = dsl.ref(SampleHandler.class);</span><br><span class="line">                                    router.GET(<span class="string">&quot;/sayHello&quot;</span>, handler::hello);</span><br><span class="line">                                &#125;)</span><br><span class="line">                                .converters(c -&gt;</span><br><span class="line">                                        c.string().jackson()</span><br><span class="line">                                )</span><br><span class="line">                    	);</span><br></pre></td></tr></table></figure>

<p>上面这段代码就是用于构造一个：</p>
<ul>
<li>端口号为 8181 （测试环境） 8080 （非测试环境）</li>
<li>路由为 <code>/sayHello</code> 访问方式为 <code>Get</code> </li>
<li>返回格式为 json</li>
</ul>
<p>的 WebDsl 整体流程我们可以理解如下的流图</p>
<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/ab33ce32-7af0-4176-962c-c353ae173f82.png" alt="WebDsl 执行流程图" style="zoom: 50%;" />

<center>[WebDsl 执行流程图]</center>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/11/Spring/SpringFu%20DSL%20%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/" data-id="cmblme3as00ehlppvagbjh4ih" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringFu/" rel="tag">SpringFu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/SpringFu 启动流程" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/11/Spring/SpringFu%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" class="article-date">
  <time datetime="2021-07-11T15:02:37.000Z" itemprop="datePublished">2021-07-11</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringFu/">SpringFu</a>►<a class="article-category-link" href="/categories/SpringFu/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/11/Spring/SpringFu%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">SpringFu 启动流程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>整个项目的启动是通过 <code>Jafu.webApplication().run()</code> 完成的，与 SpringBoot 的 <code>SpringApplication.run(SpringfuDemoApplication.class, args)</code> 有异曲同工之妙。那么核心点就是 <code>webApplication()</code> 和<code> run()</code> 方法。</p>
<p>通过 JaFu 的成员结构和注释我们能看出来，他其实是一个客户端类或者说工厂类。</p>
<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210711164338078.png" alt="image-20210711164338078" style="zoom: 33%;" />

<center>[JaFu 成员结构]</center>

<p>其实这个写法在日常代码中也是有大量应用场景的，比如我们封装一个二方包或者客户端给其他人用，他们使用起来可能需要 new 好多类，配置很多参数之后再做组装。这样一系列操作对于不熟悉这个二方包的人是非常不友好的，接入成本太高。为了防止被祭天，我们尽量采用这种工厂类或者富客户端的方式减少用户负担，屏蔽细节。</p>
<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210711165132287.png" alt="image-20210711165132287" style="zoom: 50%;" />

<center>[反面教材]</center>

<h2 id="配置-Web-APp"><a href="#配置-Web-APp" class="headerlink" title="配置 Web APp"></a>配置 Web APp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JafuApplication <span class="title">webApplication</span><span class="params">(Consumer&lt;ApplicationDsl&gt; dsl)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> JafuApplication(<span class="keyword">new</span> ApplicationDsl(dsl)) &#123;</span><br><span class="line">		<span class="meta">@Override</span></span><br><span class="line">		<span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> ServletWebServerApplicationContext();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>核心就是 new 了一个 JafuApplication ，并且指明了当前的运行环境为 <code>Web</code> 所以创建了 <code>ServletWebServerApplicationContext</code> </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/11/Spring/SpringFu%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" data-id="cmblme3at00ejlppv8xqvdz2h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/SpringFu/" rel="tag">SpringFu</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Spring/用函数写 Spring 项目你见过么 --SpringFu" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/07/10/Spring/%E7%94%A8%E5%87%BD%E6%95%B0%E5%86%99%20Spring%20%E9%A1%B9%E7%9B%AE%E4%BD%A0%E8%A7%81%E8%BF%87%E4%B9%88%20--SpringFu/" class="article-date">
  <time datetime="2021-07-10T15:02:37.000Z" itemprop="datePublished">2021-07-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring-Fu/">Spring Fu</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/07/10/Spring/%E7%94%A8%E5%87%BD%E6%95%B0%E5%86%99%20Spring%20%E9%A1%B9%E7%9B%AE%E4%BD%A0%E8%A7%81%E8%BF%87%E4%B9%88%20--SpringFu/">用函数写 Bean 你见过么</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​    函数是很多编程语言中的一等公民，并且在近些年提的很火的 <code>函数式变成</code> 以及 <code>Serverless</code> 都是通过函数来表达，每个函数提供一个单一功能的服务。他们相互作用，相互引用组装出复杂的功能。当云计算重构整个 IT 产业的同时， 也赋予了企业崭新的增长机遇。正如集装箱的出现加速了贸易全球化进程，以容器为代表的云原生技术作为云计算的服务新界面加速云计算也推动着软件架构向云原生演进。在当下处处都在呼吁 <code>云原生</code> 和 <code>反应式架构</code>的大背景下， Java 以及他的好搭档 Spring 又在做出怎么样的改变去紧跟这个新浪潮呢 ？</p>
<center> <img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/cloud-native-architecutre-mindnode-20210710150004646.jpg" alt="Cloud native思维导图" style="zoom: 33%;" /></center>
  <center> [云原生概念导图] </center>



<p>​    这里我们就要请出我们的主角 <code>SpringFu</code> , 据官方声称使用 SpringFu 搭建 SpringBoot 应用比普通自动配置的 SpringMVC 项目要快上 40% ，并且得益于很少使用反射特性能够非常好的适应 <code>GraalVM native</code> 同时还有内存占用量低等等优势。</p>
<h2 id="GayHub"><a href="#GayHub" class="headerlink" title="GayHub"></a>GayHub</h2><p>​        其实 SpringFu 项目分为  <a target="_blank" rel="noopener" href="https://github.com/spring-projects-experimental/spring-fu/tree/main/jafu">JaFu</a> (Java DSL) and <a target="_blank" rel="noopener" href="https://github.com/spring-projects-experimental/spring-fu/tree/main/kofu">KoFu</a> (Kotlin DSL) ，也就是他既做了 Java 版本也做了 Kotlin 版本，作者也考虑了极为先进的卡特琳了，虽然这个语言我学过几天后再也没使用过，在平时的工作中我使用 Groovy 的频率都比 Kotlin 高。</p>
<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710152019688.png" alt="image-20210710152019688" style="zoom: 50%;" />



<p>先创建一个简单的 SpringBoot 工程，可以使用 <a target="_blank" rel="noopener" href="https://start.spring.io/">https://start.spring.io/</a>  这个 Spring 官方的脚手架搭建工具，当然如果你是跟我一样的 Idea 的重度用户也可以使用 Idea 的 <code>SpringInitializr</code> </p>
<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710153046306.png" alt="image-20210710153046306" style="zoom:50%;" />



<h2 id="加载依赖的小插曲"><a href="#加载依赖的小插曲" class="headerlink" title="加载依赖的小插曲"></a>加载依赖的小插曲</h2><p>再到主 POM 里加下下面这这段朴实无华的代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.fu<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-fu-jafu<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.4.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但是当你更新 Maven 依赖的时候发现这个包并不会被拉下来，然后我果断换掉了 阿里云  的 Maven 镜像源，变成了 <a target="_blank" rel="noopener" href="http://maven.net.cn/content/groups/public/">http://maven.net.cn/content/groups/public/</a> 然后赤裸裸的 Error 又把我打入地狱，什么玩意中央仓库都没有这个包？于是我拿着这个 artifactId 去 <a target="_blank" rel="noopener" href="https://mvnrepository.com/">https://mvnrepository.com/</a> 全网 Maven 仓库查询了下，然后我注意到他有这么个 Tag ，呵 ！！！给我来这套</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710160236238.png" alt="image-20210710160236238"></p>
<p>于是乎我经历了第三次变更 Maven 镜像源，我也懒得配置 mirrorOf 了，直接把这个镜像源提到第一个按照优先级先到这个镜像仓库取拉包，这次果然没有问题了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirrors</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- mirror | Specifies a repository mirror site to use instead of a given   </span></span><br><span class="line"><span class="comment">              repository. The repository that | this mirror serves has an ID that matches   </span></span><br><span class="line"><span class="comment">              the mirrorOf element of this mirror. IDs are used | for inheritance and direct   </span></span><br><span class="line"><span class="comment">              lookup purposes, and must be unique across the set of mirrors. | --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-sp<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus sp<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-163<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>*<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus 163<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://mirrors.163.com/maven/repository/maven-public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>nexus-aliyun<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus aliyun<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">id</span>&gt;</span>net-cn<span class="tag">&lt;/<span class="name">id</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>Nexus net<span class="tag">&lt;/<span class="name">name</span>&gt;</span>  </span><br><span class="line">      <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.net.cn/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span>  </span><br></pre></td></tr></table></figure>



<p>​    因为我勾选了 SpringData ，所以我必须配置一个数据源，这里我就用本地的 MySQL 当做测试数据源，让项目先跑起来。</p>
<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710161001751.png" alt="image-20210710161001751" style="zoom: 50%;" />

<p>​    不出意外，MacBook Pro 运行这种小程序就是快！</p>
<h2 id="改造主程序"><a href="#改造主程序" class="headerlink" title="改造主程序"></a>改造主程序</h2><p>​    我们都清楚，SpringBoot 的加载是通过主类来完成的，想让 SpringFu 来作为整个项目的启动器我们就需要对 <code>SpringfuDemoApplication </code> 做做改造了。注意如下代码请不要抄官方文档，你不可能跑起来的，因为他们的 demo 使用了一个 protected 的方法，如果你不是通过源码依赖是不可能调用到这个方法的，所以这里我换了一个写法，加载完 ioc 容器后在外部手动 enable 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> JafuApplication app = webApplication(ioc -&gt;</span><br><span class="line">            ioc.beans(beanDefinition -&gt;</span><br><span class="line">                    beanDefinition.bean(SampleHandler.class).bean(SampleService.class)</span><br><span class="line">            ).enable(webMvc(dsl -&gt;</span><br><span class="line">                    dsl.port(dsl.profiles().contains(<span class="string">&quot;test&quot;</span>) ? <span class="number">8181</span> : <span class="number">8080</span>)</span><br><span class="line">                            .router(router -&gt; &#123;</span><br><span class="line">                                SampleHandler handler = dsl.ref(SampleHandler.class);</span><br><span class="line">                                router.GET(<span class="string">&quot;/sayHello&quot;</span>, handler::hello);</span><br><span class="line">                            &#125;)</span><br><span class="line">                            .converters(c -&gt;</span><br><span class="line">                                    c.string().jackson()</span><br><span class="line">                            )</span><br><span class="line">            ))</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        app.run(args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>其中依赖了 <code>SampleHandler</code> 这个处理器 代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleHandler</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ServerResponse <span class="title">hello</span><span class="params">(ServerRequest request)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ok().body(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>​    启动后访问，大功告成。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210710175442941.png" alt="image-20210710175442941"></p>
<h2 id="新旧比较"><a href="#新旧比较" class="headerlink" title="新旧比较"></a>新旧比较</h2><h3 id="加载-bean"><a href="#加载-bean" class="headerlink" title="加载 bean"></a>加载 bean</h3><p>在传统的 Spring 加载 Bean 一般是通过 xml 或者 JavaConfig 的方式，这里演示下相对比较简单的 JavaConfig 声明 Bean 的方式。通过一个 <code>@Configuration</code>  注解告诉 Spring 他是一个配置类，其中的每个 <code>@Bean</code> 声明的方法都是容器中的一个 Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">user</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Student <span class="title">student</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Student();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>而在 SpringFu 中使用就变得简单起来了，通过 <code>ConfigurationDsl</code> 的 beans 方法注册 bean，方法接受了一个 <code>Lambda</code> 表达式来加载 bean 。所以说在 SpringMVC 或者 SpringBoot 中需要使用 <code>@Component</code> 的地方最终都会使用 <code>ConfigurationDsl#beans</code> 来代替</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ioc.beans(beanDefinition -&gt;</span><br><span class="line">              beanDefinition.bean(SampleHandler.class)</span><br><span class="line">              .bean(SampleService.class)</span><br><span class="line">              .bean(Sample.class)</span><br><span class="line">         )</span><br></pre></td></tr></table></figure>



<h3 id="Web-路由"><a href="#Web-路由" class="headerlink" title="Web 路由"></a>Web 路由</h3><p>在 SpringMVC 中是通过 <code>@RequestMapping(&quot;/api/demo&quot;)</code> 这个注解来表名当前哪个路径会路由到当前类或者方法，而在 SpringFu 中则有专门的 DSL 来描述这个映射关系，比如我们上面用到的 <code>WebMvcServerDsl</code> 并且他定义了一系列的方法来配置 web 相关信息，比如用到的 <code>port</code> 和 <code>router</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/echo&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>在 SpringFu 中我们把 Controller 叫做 Handler , 路由配置方式也与之前有些差异：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">webMvcDsl.router(router -&gt; &#123;</span><br><span class="line">      SampleHandler handler = dsl.ref(SampleHandler.class);</span><br><span class="line">      router.GET(<span class="string">&quot;/sayHello&quot;</span>, handler::hello);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>整体来看，从 SpringMVC 到 SpringFu 改动的不仅仅是表达方式，而是一种编程思维，通过 <code>DSL</code> 抽象组件再通过 <code>Function</code> 的组合以及注册完成框架配置和业务展开。其实 SpringFu 的定位并不是替代 SpringMVC 而是在云原生以及在<code>Serverless</code>等以函数为主体的轻应用场景中发挥巨大作用。</p>
<p>本篇主要介绍 SpringFu 项目搭建，体验了一把总体感觉还是不错的除了有不少坑之外，下篇会看看关于 SpringFu 所用到的设计思想以及类关系简单的源码分析。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/10/Spring/%E7%94%A8%E5%87%BD%E6%95%B0%E5%86%99%20Spring%20%E9%A1%B9%E7%9B%AE%E4%BD%A0%E8%A7%81%E8%BF%87%E4%B9%88%20--SpringFu/" data-id="cmblme3au00enlppv9b654y2b" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Tomcat/揭秘 Tomcat（一） - 启动" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/06/27/Tomcat/%E6%8F%AD%E7%A7%98%20Tomcat%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E5%90%AF%E5%8A%A8/" class="article-date">
  <time datetime="2021-06-27T14:39:26.000Z" itemprop="datePublished">2021-06-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Tomcat/">Tomcat</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/06/27/Tomcat/%E6%8F%AD%E7%A7%98%20Tomcat%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E5%90%AF%E5%8A%A8/">揭秘 Tomcat - 启动</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>tomcat 对于每一个 Java 工程师都是一个既熟悉又神秘的黑盒，什么 web 容器，什么三大组件，什么web.xml ….. 这些令人迷惑的问题都会在 《揭秘 Tomcat》系列文章中掰扯的清清楚楚。</p>
<p> <img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1590165360512-927ede67-214d-460c-a928-90bdca6bbd88-20210627194357458.png" alt="image.png"></p>
<h2 id="从启动说起"><a href="#从启动说起" class="headerlink" title="从启动说起"></a>从启动说起</h2><p>启动 tomcat 非常简单 ， <code>./startup.sh</code> 一行命令，起飞 ~ 打开这个 shell 脚本我们发现最终启动了一个 Java 的 main 方法，也就是整个tomcat 的入口  <code>org.apache.catalina.startup.Boostrap</code> 瞅一眼简化后的代码 ~</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1590165821369-01da8b92-bedb-495b-a856-d02aa16fbba6-20210627194354707.png" alt="image.png"></p>
<p>简要的做一下分析启动参数，main 方法可以传入 startd、stopd、start、stop，startd 作为参数。其中 start 和 startd 区别就是将 await 设置为 true ，即程序是需要后台运行，还是在前台等待用户操作。</p>
<p>启动主要做了以下三件事情:</p>
<ol>
<li><ol>
<li>实例化 Boostrap ，并初始化</li>
<li>调用 load 方法</li>
<li>调用 start 方法</li>
</ol>
</li>
</ol>
<p>接下来就从以上三个步骤，来揭秘 tomcat 启动流程。</p>
<h2 id="初始化启动器【init】"><a href="#初始化启动器【init】" class="headerlink" title="初始化启动器【init】"></a>初始化启动器【init】</h2><p>直接上代码看起来会比较蛋疼，我们先整理下思路，调用 <code>Boostrap#init</code> 方法主要完成三件事：</p>
<ol>
<li>初始化类加载器：初始化 Tomcat 核心加载器：<code>commonLoader</code>、<code>catalinaLoader</code>、<code>sharedLoader</code> ，后续会详细介绍这三个类加载器的作用以及使用场景。</li>
</ol>
<ol>
<li>设置主线程 classLoader 为catalinaLoader，安全管理的 classLoad 为catalineLoader。</li>
</ol>
<ol>
<li>通过反射生成Catalina对象，设置 Catalina 父加载器为 sharedLoader </li>
</ol>
<p>初始化的核心代码如下：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/image-20210627194240506.png" alt="image-20210627194240506"></p>
<p>总结下来就是初始化了类加载器，即关键的一行就是 initClassLoaders()，它加载了/conf/catalina.properties 中的 common.loader、shared.loader、server.loader 对应的jar包和 properties 等文件，最后初始化了Catalina类，这个类将是加载我们 web 的 classloader。所以我们的自定义的文件或者 jar 包 都可以通过配置common.loader来加载 ，比如公共配置文件，日志文件等等。</p>
<p>看看 initClassLoaders() 方法代码，我们发现这几个类加载器默认情况下都是指向的 commonLoader，从源码可以看到，tomcat commonLoader 的父加载器为null，违背了java自己的类加载机制。那么问题来了 tomcat 为什么要定义自己的 classLoader ？</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593849559785-0bc2e39b-fed7-4e30-8f27-9003362b99af-20210627194253547.png" alt="image.png"></p>
<p>​    我们知道 Java 默认是遵循双亲委派模型的，听起来高大上的名词，用一句话来解释就是所有类加载器优先使用父加载器进行类的加载。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593523834557-c7ea4c3e-9bf6-408c-9b5a-d73d5c68cfd3-20210627194258231.png" alt="image.png"></p>
<p>Java 体系中默认的类加载器遵循上图的父子关系，也就是说大部分的类都是最顶层的 BootStrap 这个类加载器进行加载的。这样做的好处就是保证 JDK 中的基础类不会被改写，另外防止一个类被不同的类加载器重复加载多次。</p>
<p>但是为什么 tomcat 没有使用默认的类加载机制，而是自己另起一套呢？看下下面几个场景：</p>
<ul>
<li><ul>
<li>tomcat 中可以部署多个项目，但是这多个项目可能依赖同一个类库的不同版本假如都使用 bootstrap 去加载那么就会出现类冲突谁知道要加载哪个版本； -&gt; 衍生出 WebAppClassLoader</li>
<li>tomcat 内部依赖的 jar 和类库如果不和应用程序隔离的话应用程序中的类可以轻易覆盖 tomcat 中的核心类库造成安全问题； -&gt; 衍生出 catalinaLoader</li>
<li>应用程序和tomcat 都需要的类库大家可以共用的就不需要重复加载；-&gt; 衍生出 Shared ClassLoader</li>
</ul>
</li>
</ul>
<p>简单看下 tomcat 的类加载体系：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593524986228-d3bcd9f8-38c9-4b4f-aa4b-e18bc54071df-20210627194303384.png" alt="image.png"></p>
<p>他们的功能从名字就能看出来时干嘛的，简单列举下功能：</p>
<ul>
<li><ul>
<li>commonLoader：Tomcat最基本的类加载器，加载路径中的class可以被Tomcat容器本身以及各个Webapp访问；</li>
<li>catalinaLoader：Tomcat容器私有的类加载器，加载路径中的class对于Webapp不可见；</li>
<li>sharedLoader：各个Webapp共享的类加载器，加载路径中的class对于所有Webapp可见，但是对于Tomcat容器不可见；</li>
<li>WebappClassLoader：各个Webapp私有的类加载器，加载路径中的class只对当前Webapp可见；</li>
</ul>
</li>
</ul>
<h2 id="加载容器组件-【load】"><a href="#加载容器组件-【load】" class="headerlink" title="加载容器组件 【load】"></a>加载容器组件 【load】</h2><p>紧接着调用了 Bootstrap 的 load 方法，看下简化后的代码：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593528839395-d21d5374-f77b-4877-8c8f-4d14cef4a3e0-20210627194310073.png" alt="image.png"></p>
<p>直接调用到了 Catalina#load 方法</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593527238438-3eb5e324-8c86-43fb-bc26-52ff6ca1fa1d-20210627194314428.png" alt="image.png"></p>
<p> 简单介绍下上面代码的作用，configFile() 方法返回了 server.xml 文件, Digester 解析该文件，得到容器的配置，并创建容器组件和容器。这个地方的解析 xml 生成一系列的对象的逻辑很牛逼，也很复杂后面会专门有一篇文章来解析这部分逻辑！</p>
<p>依次创建的组件为 ：StandardServer、 StandardService、StandardEngine、StandardHost。然后拿到 StandardServer 实例调用 init() 方法初始化 Tomcat 容器的一系列组件。一些容器初始化的时候，都会调用其子容器的 init() 方法，初始化它的子容器，相当于每个容器都在初始化自身相关设置的同时，将子容器初始化。所以着重看下 init 方法</p>
<p>init 方法并不是 Server 类中的，而是他从 Lifecycle 接口的子类中继承的。就拿 StandardServer 举例， 他继承了 LifecycleMBeanBase ，可以看到他的初始化逻辑(下图的 init 方法) 并没有直接写出来，而是通过一个抽象方法让子类实现，而在本类中实现通用的逻辑，比如状态机的设定，异常处理。这就是大名鼎鼎的 <code>模板设计模式</code> ，读 tomcat 还能学学设计模式，血赚有没有<del>~</del></p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593856082499-5d86fe50-e9f4-423f-b0ae-c64d44d28a23-20210627194322188.png" alt="image.png"></p>
<p>而这个类里面的模板占位符 <code>initInternal</code> 被 20 多个类进行了覆盖，都是我们的 tomcat 组件</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593855896060-60bdadcb-0ab5-4055-8933-7e80ac35dcab-20210627194328259.png" alt="image.png"></p>
<p>同理  destroy -&gt; destroyInternal ，start -&gt; startInternal ，stop -&gt; stopInternal 都是使用了相同的手法。</p>
<h2 id="启动容器-【start】"><a href="#启动容器-【start】" class="headerlink" title="启动容器 【start】"></a>启动容器 【start】</h2><p>最后一步就是 start ，调用后就能成功看到  <code>Server startup in 1222 ms </code> 这样一行标志性的日志了</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593870761232-b3ae56f5-a65b-4b9a-8fc1-42c4d57cdf00-20210627194333667.png" alt="image.png"></p>
<p>同样的，他还是调用了 <code>org.apache.catalina.startup.Catalina#start</code> 代码判断异常的逻辑较多，可以简化为下面的形式</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1593871002514-5b7fb7ad-59bb-44d9-942e-deb6f1ee275d-20210627194337111.png" alt="image.png"></p>
<p>如果没有初始化 server 那么重新初始化一下，这是一个好习惯，做一个兜底防止程序马上就挂了；之后调用了 server 组件的 start 方法，前面我们知道 server 组件初始化会调用内部的 initInternal ，start 也是同理的会调用内部的 start 他们都是生命周期接口中的方法。主要的事情就是启动子组件；</p>
<p>接着就注册了一个钩子函数，这是 jdk 中自带的线程停止后会执行另外一个线程帮他清理数据；</p>
<p>最后就是调用 await () 进行 web 端口的监听，启动后台线程池接受 http 请求，这样整个 tomcat 就启动完毕了，在 await 过程中方法是不会返回的所以 stop 不会被执行，而程序接收到 stop 的命令后会返回执行 stop 方法清理数据</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这里和大家主要从宏观的角度了解 tomcat 的启动流程，主要分为 init，load，start 三部分，而且很多中间件都是这三个部分组成的，不论是后面会讲到的 spring 还是 dubbo 大致流程都是如此，对我们后期看其他中间件源码会有一个大致的思路。</p>
<p>而且对于整个启动过程可以总结为三句话：</p>
<ul>
<li><p>初始化 toncat 类加载器系统</p>
</li>
<li><p>解析 server.xml 初始化 tomcat 系统组件</p>
</li>
<li><p>tomcat 组件启动，钩子注册，端口监听</p>
</li>
</ul>
<ol>
<li><ol>
<li></li>
</ol>
</li>
</ol>
<p>后续的文章会对这三部分进行详细的解读，里面使用的设计模式 ， 优秀的写法， 良好的风格我都会和大家一起探讨进步。关注我，在技术的道路上十年如一日的进步 ！</p>
<p>另外：大家也可以关注下我的微信公众号哦~ 技术分享和个人思考都会第一时间同步！</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610289331606-52e03a47-f431-4b20-8b57-6a4cc0f70345.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/27/Tomcat/%E6%8F%AD%E7%A7%98%20Tomcat%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E5%90%AF%E5%8A%A8/" data-id="cmblme3b500fxlppv0ri73qbq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-SpringBoot/Spring 启动加速异步 Bean" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/05/27/SpringBoot/Spring%20%E5%90%AF%E5%8A%A8%E5%8A%A0%E9%80%9F%E5%BC%82%E6%AD%A5%20Bean/" class="article-date">
  <time datetime="2021-05-27T22:39:26.000Z" itemprop="datePublished">2021-05-27</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/SpringBoot/">SpringBoot</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/05/27/SpringBoot/Spring%20%E5%90%AF%E5%8A%A8%E5%8A%A0%E9%80%9F%E5%BC%82%E6%AD%A5%20Bean/">SpringBoot 启动加速</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>在 2021 年这个小学作文中的未来年份，没有想象中的汽车满天飞，也没有实现机器人满地跑。但牛逼的是我们都有一个共识： 知乎达到了人均 “谢邀~ 人在美国刚下飞机”的生活水平，虎扑的人均收入也在 30W+ ，还有就是程序员都人均精通 SpringBoot ，哪怕和算法聊技术一言不合就满嘴 SpringCould 分布式、微服务，然而实际操作可能是 <strong>分步试</strong> 、<strong>伪服务</strong> … 你一个小小系统开这么多应用启动不难受？(不难受因为可以装 13)   SpringBoot 这启动速度也确实令人捉急，每个应用 5 分钟改个小功能，编码五分钟部署俩小时。 so 如何更加优雅快速的  启动 SpringBoot 应用 (满足装 13 的欲望) 呢？</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1618727885214-dd6dfd2d-7c9f-4e06-9b68-f7ea14e1d360-20210627195044309.jpeg" alt="IMG_3485.jpg"></p>
<p>其实我们都比较清楚大部分的启动时间是由于 Spring 需要加载各种 Bean 导致启动速度下降的，那么对于那些不是特别重要的 Bean 我们是不是可以让他再起一个线程做 Bean 初始化，不阻塞主线程启动，这样启动速度不就起来了么，说干就干！</p>
<p>那你肯定会问，我们咋判断一个 Bean 加载时间长短，找出那些 <code>拉跨的Bean</code> 呢？内心一阵嘲讽，嘴角泛出一阵冷笑后 不慌不忙的道来：“这对于精通 Spring 框架的我来说不是小菜一碟么 ”。我掐指一算，就知道是哪几个 Bean 拉跨。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619414062442-1cb5a1cc-3702-4fa8-937d-0dd75fb37ecc-20210627195048353.png" alt="image.png"></p>
<h3 id="统计-Bean-初始化时间"><a href="#统计-Bean-初始化时间" class="headerlink" title="统计 Bean 初始化时间"></a>统计 Bean 初始化时间</h3><p>简单做法就是通过 BeanPostProcessor ，祭出这个神器就能干倒一半的 LSP，很多使用 Spring 的 LSP 其实都不太知道这个玩意，那他到底是个什么玩意呢？简单来讲就是 Spring 初始化 Bean 的钩子函数。 Bean 是否加载，加载的是哪个 Bean 以及修改 Bean 的相关属性都可以通过这个钩子函数搞定。这就是一个活生生的 Spring 后门，学会了他 Spring 框架任你摆布。</p>
<p>后面我会专门开一篇文章去讲解 BeanPostProcessor  如何帮你加载 Bean，以及如何利用这个后门搞事情。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619265336642-31eb298f-f2d5-4025-b431-64262d48f1b7-20210627195051841.jpeg" alt="unnamed.jpg"></p>
<p>所以我们现在讲讲如何用 BeanPostProcessor  统计 Bean 的初始化时间。不多 BB 直接上代码：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619266023651-dc9b9630-a24a-4847-9bbe-3278ca3203c5-20210627195055164.png" alt="image.png"></p>
<p>我们编写了 BeanInitCostTimeBeanPostProcessor 继承了 BeanPostProcessor   实现了 postProcessBeforeInitialization 和 postProcessAfterInitialization 分别代表了 Bean 初始化之前和之后，简单记录了 Bean 初始化开始时间，然后用结束时间减去开始时间就得到了具体的初始化时间。</p>
<p>我专门在 Spring 容器中放了一个加载时间很长的测试 Bean ，代码如下</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619267993440-bc8b9a0d-0a58-443c-8bec-93f209ebbc46-20210627195101201.png" alt="image.png"></p>
<p>效果如下：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619267872243-88f9a69e-f3ea-446e-aca7-151469cd7a7e-20210627195104385.png" alt="image.png"></p>
<h3 id="异步-Bean-实操"><a href="#异步-Bean-实操" class="headerlink" title="异步 Bean 实操"></a>异步 Bean 实操</h3><p>异步 Bean 异步 Bean ，首先这个 Bean 需要是个异步的，那如何将一个 Bean 包装成异步的呢？首先异步 Bean 肯定需要继承原来的 Bean 需要保证是同一种类型的，然后重写他的 init 方法。代码操作如下：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619270159828-93a6a66e-2d1b-4095-9b36-b2d9a34f6c9a-20210627195107701.png" alt="image.png"></p>
<p>但是这么写并不是很优雅，假如我们还需要在初始化 Bean 的时候做一些其他操作，直接继承是不方便的。所以必须祭出 Spring 中的另外一个组件了，工厂 Bean，学名 FactoryBean 这个要和另外一个叫做 BeanFactory 的大佬区分开。 工厂 Bean 顾名思义就是这个玩意也是一个 Bean 只是他的主要职责是作为工厂，通常用于生成特定类型的 Bean ，那么我们就有一个骚操作了，让这个工厂生产的 Bean 就是它自己，而且中间还能定义很多额外的逻辑，不多 BB 上代码</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619270390154-8e7ca014-acab-4e52-a16a-df28fd77ae02-20210627195111231.png" alt="image.png"></p>
<p>然后通过异步 Bean 去加载我们看看前后的差别</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619270486905-7201f393-7ac0-4935-bb8c-f44115429fb1-20210627195114682.png" alt="image.png"></p>
<p>优化之前：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619270568290-278de048-c70a-4406-a7a6-5c1f37a4e85b-20210627195118350.png" alt="image.png"></p>
<p>优化之后：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1619270528731-9322ec40-94ed-4225-b74b-fcf9d6975189-20210627195120945.png" alt="image.png"></p>
<p>可以看到优化后 1.4s 应用就启动完成了，而且耗时的 Bean 可以让他慢慢加载，在应用启动完成后这个 Bean 才完全被加载。</p>
<h3 id="唠叨"><a href="#唠叨" class="headerlink" title="唠叨"></a>唠叨</h3><p>最近有点忙成狗，从四月就断更到现在了，今天抽个周末的时候终于写完了。</p>
<p>不过最近看了好几本书，也准备抽点时间写写读后感了，非常推荐大家看看 《零秒思考》 ，同时写点个人的小思考： 一旦适应了用语言表达脑海中的意向和感觉，渐渐地就不会为如何表达自己的心情和想法而苦恼，流畅清晰的表达能够更快的与对方沟通让对方心领神会。表达不善往往便会产生一种想也是白想的放弃心理，由此甚至连思考本身也放弃了，不思考人就不会成长，不经历思考解决手头的事情人就会失去干劲变得无聊。</p>
<p>另外：大家也可以关注下我的微信公众号哦~ 技术分享和个人思考都会第一时间同步！</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610289331606-52e03a47-f431-4b20-8b57-6a4cc0f70345-20210627195142247.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/05/27/SpringBoot/Spring%20%E5%90%AF%E5%8A%A8%E5%8A%A0%E9%80%9F%E5%BC%82%E6%AD%A5%20Bean/" data-id="cmblme3av00eslppv0q2k0itn" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kafka系列文章/Kafka 探险 - 源码环境搭建" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/14/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="article-date">
  <time datetime="2021-01-14T17:20:28.000Z" itemprop="datePublished">2021-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Kafka-%E6%8E%A2%E9%99%A9/">Kafka 探险</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/14/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">Kafka 探险 - 源码环境搭建</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>这个 Kafka 的专题，我会从系统整体架构，设计到代码落地。和大家一起杠源码，学技巧，涨知识。希望大家持续关注一起见证成长！</p>
<p><strong>我相信：技术的道路，十年如一日！十年磨一剑！</strong></p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在阅读源码之前，首先要做的就是搭建一套源码调试环境，这是最基本的一步，不要觉得麻烦或者简单就不去做，也许你会像我一样搭源码的过程中得到一些教训和经验。同时在后面阅读源码的过程中，很多看不懂的地方 debug 一下也许就明朗了。</p>
<p>记录了搭建 Kafka 源码环境的简单过程，为大家提供一个步骤参考，同时记录搭建环境中可能会遇到的问题及解决方案。</p>
<p>这个环境搭建过程也会提到一个非常实用，并且很多人都不知道的源码 debug 技巧，对阅读源码和 debug 系统很有帮助哦！</p>
<h2 id="源码下载"><a href="#源码下载" class="headerlink" title="源码下载"></a>源码下载</h2><p>笔者下载的 Kafka 版本是 0.11.0.1 ，源码下载地址是 ：<a target="_blank" rel="noopener" href="https://kafka.apache.org/downloads">https://kafka.apache.org/downloads</a></p>
<p>下载时选择，源码下载：</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610295908149-3d876882-2f6c-4e16-acfe-402b957d4660-20210627195924507.png" alt="image.png"></p>
<h2 id="解压工程-amp-安装插件"><a href="#解压工程-amp-安装插件" class="headerlink" title="解压工程&amp;安装插件"></a>解压工程&amp;安装插件</h2><p>解压下载好的源码包，直接使用 Idea 打开项目即可。另外由于 Kafka 代码是 Scala 写的，所以需要安装一个 Scala 插件。</p>
<p>到 Idea 的插件市场下载 Scala 插件，这个插件不仅仅有语法提示而且可以帮你下载 Scala SDK，切换 SDK 非常方便，必装！</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610296138821-fff657cf-7d63-4a49-8730-56489f5b38d5-20210627195927355.png" alt="image.png"></p>
<h2 id="仓库初始化"><a href="#仓库初始化" class="headerlink" title="仓库初始化"></a>仓库初始化</h2><p>养成一个好习惯，对于这种直接下载的源码包，先用 git 进行初始化，后续有什么改动也能够进行回溯，防止直接把源码改瓢了，之前做的注释也很难再拷贝出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git add . &amp;&amp; git commit -m &#39;init&#39;</span><br></pre></td></tr></table></figure>



<h2 id="构建项目"><a href="#构建项目" class="headerlink" title="构建项目"></a>构建项目</h2><p>修改项目根目录下的 build.gradle ，将所有的 <code>mavenCentral()</code> 替换成  <code> maven&#123; url &#39;http://maven.aliyun.com/nexus/content/groups/public/&#39;&#125;</code> 加快 gradle 导入包的速度。</p>
<p>完事以后开始进行 Gradle 构建</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610296394234-61bc8d50-cd52-4c92-9f59-c7cf8141b0ce-20210627195932098.png" alt="image.png"> </p>
<p>构建完成后，所有的 Kafka 些模块会被自动导入，如下图是导入完成时的工程模块结构</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610296724147-b6075fae-0c69-4293-a46c-86ae8af2a7fe-20210627195935115.png" alt="image.png"></p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><p>找到 kafka.Kafka 这个类，然后运行 Main 方法，添加启动参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vmOptions -&gt;  -Dkafka.logs.dir&#x3D;&#x2F;Users&#x2F;lwen&#x2F;logs&#x2F;kafka   # 这个目录需要修改一下，是 kafka 消息文件目录</span><br><span class="line"></span><br><span class="line">program arguments -&gt;  config&#x2F;server.properties  # kafka 的配置文件路径</span><br></pre></td></tr></table></figure>



<p>下图展示配置完毕时的参数</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610383541230-9bf79e7f-8ea9-414b-ba1b-ffa27573b721-20210627195938389.png" alt="image.png"></p>
<p>我遇到了很多编译警告⚠️，不过只要还能继续编译就不用 care。</p>
<p>令人悲伤的是程序启动不起来，main 方法直接退出了，没有任何的提示。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610297238930-cad4aec6-ae09-439e-a8f4-9a3ecc2dbf30-20210627195941776.png" alt="image.png"></p>
<h2 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h2><p>遇到上面那个问题后，找不到任何的日志看出是因为什么导致的，当时看网上的教程是把 log4j 配置文件拷贝到 kafka 目录，日志就能生效，但是我尝试过了也不 OK。</p>
<p>所以我就开始 debug，找出为什么这个地方会出现 exit with 1 ，这里介绍一个调试源码的技巧：我们看到代码是遇到了异常才退出的，但是我们没有异常堆栈和错误提示，可以肯定的是程序肯定遇到异常了。</p>
<p>所以我们在 Idea 中，断点所有会发生异常的位置具体操作：</p>
<p>cmd+shift+f8 打开断点窗口</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610885167175-17d6d533-5b46-496f-9f25-8b1d6da3921c-20210627195944898.png" alt="image.png"></p>
<p>勾选上 Any Exception ，并在 Catch Class Filter 中去掉 ClassNotFoundException 因为在程序运行的时候会有双亲委派的类加载过程，肯定会触发 ClassNotFoundException 。这样配置以后，程序抛出任何非 ClassNotFoundException 的位置都会停下来</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610885340427-2fb68d6f-3280-4733-8e58-2322de105227-20210627195948492.png" alt="image.png"></p>
<p>以 debug 的方式启动程序，最后我发现程序在  initZk() 的地方异常了，那就很清晰了，zk 配置问题</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610885430723-f3324af0-23e5-4371-b71f-ce5ce921329a-20210627195951761.png" alt="image.png"></p>
<p>这个有点坑！主要是因为没有开启日志，所以一行日志没有直接抛出异常结束进程了，后来我也找到打印日志的方法，按照我上面的启动参数配置就可以。</p>
<p>所以原因是没有启动 zk，那么下一步就是安装 zk。</p>
<h2 id="安装-ZK"><a href="#安装-ZK" class="headerlink" title="安装 ZK"></a>安装 ZK</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install  zookeeper</span><br></pre></td></tr></table></figure>

<p> 安装完了以后启动 zk ，我采用的是 后台运行的方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew services start zookeeper</span><br></pre></td></tr></table></figure>

<p>​    当然也可以直接前台启动，看到日志输出:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zkServer start</span><br></pre></td></tr></table></figure>

<h2 id="再次启动"><a href="#再次启动" class="headerlink" title="再次启动"></a>再次启动</h2><p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610383610463-3abb66b5-9aee-4181-8ca5-2eb77ce68fb7-20210627195956185.png" alt="image.png"></p>
<h2 id="唠叨"><a href="#唠叨" class="headerlink" title="唠叨"></a>唠叨</h2><p>本来以为搭建源码挺简单的，但是还是自己把自己坑了一把。日志没配，zk 没配。不过好在这个过程中，就算没有任何日志和堆栈也能分析到问题的原因，也是调试的一个小技巧，相当实用。</p>
<p>下篇文章要开始分析 Producer 的架构啦，首先我们会尝试自己实现一个 Producer ，然后再和官方的对比，看看优秀的代码在设计中更关注的点以及是如何实现的。</p>
<p>另外：大家也可以关注下我的微信公众号哦~ 技术分享和个人思考都会第一时间同步！</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610289331606-52e03a47-f431-4b20-8b57-6a4cc0f70345-20210627195959764.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/14/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" data-id="cmblme38z007xlppvbzgx5rb3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka-%E6%8E%A2%E9%99%A9/" rel="tag">Kafka 探险</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-DB/Mybatis 常用标签含义" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/10/DB/Mybatis%20%E5%B8%B8%E7%94%A8%E6%A0%87%E7%AD%BE%E5%90%AB%E4%B9%89/" class="article-date">
  <time datetime="2021-01-10T08:01:28.000Z" itemprop="datePublished">2021-01-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Mybatis/">Mybatis</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/10/DB/Mybatis%20%E5%B8%B8%E7%94%A8%E6%A0%87%E7%AD%BE%E5%90%AB%E4%B9%89/">Mybatis 常用标签</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="trim"><a href="#trim" class="headerlink" title="trim"></a>trim</h2><p>这个标签的作用就是帮你给标签的内容的头部或者尾部 <code>删除</code> 或者 <code>添加</code> 特定字符。</p>
<p> 举个例子：</p>
<p>我们的 where 下面经常会有各种条件，假如这些条件我们一个都不传那么我们就应该删除这个 where ，也或者说如果标签里面的内容不为空的话那么就给我们加上 where</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;WHERE&quot;</span> <span class="attr">prefixOverrides</span>=<span class="string">&quot;AND |OR &quot;</span>&gt;</span></span><br><span class="line">  ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这段的意思就是：</p>
<ol>
<li>如果 trim 标签里面的内容为空，那么不要加 where ，否则加上</li>
<li>如果标签里面的第一个元素是 and 或者是 or 那么删除这个 and 或者是 or</li>
</ol>
<h2 id="Where"><a href="#Where" class="headerlink" title="Where"></a>Where</h2><p>这个标签如果看懂了上面的话，那么他的意思就是上面的那段 tirm</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/10/DB/Mybatis%20%E5%B8%B8%E7%94%A8%E6%A0%87%E7%AD%BE%E5%90%AB%E4%B9%89/" data-id="cmblme370001llppvc0648xi4" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kafka系列文章/Kafka 探险 - 架构简介" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/08/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/" class="article-date">
  <time datetime="2021-01-08T17:20:28.000Z" itemprop="datePublished">2021-01-08</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Kafka-%E6%8E%A2%E9%99%A9/">Kafka 探险</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/08/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/">Kafka 探险 - 架构简介</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>这个 Kafka 的专题，我会从系统整体架构，设计到代码落地。和大家一起杠源码，学技巧，涨知识。希望大家持续关注一起见证成长！</p>
<p><strong>我相信：技术的道路，十年如一日！十年磨一剑！</strong></p>
</blockquote>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Kafka 是一种分布式的，基于发布 / 订阅的消息系统。最初被 LinkedIn 开发，并在 2011 年初开源，2012 年 10 月从 Apache 孵化器破壳而出，成为 Apache 的顶级项目。</p>
<p>Kafka 最初被设计的目的是 LinkedIn 流量和运维数据分析。流量数据包含 PV (Page View) , UV (Unique Visitor) ,搜索数据，详情页数据等。在高并发场景对于这些数据的统计并非实时的，不是简单的对于数据库的某个字段数据量 +1 这么简单，超大的流量洪峰下并不能因为统计数据将业务主流程阻塞。所以通常会将这些数据记录在文件或大数据存储引擎中，然后周期性的进行统计分析。</p>
<p>Kafka 被越来越多的公司青睐主要和他的特性优势有关：</p>
<ul>
<li>以 O(1) 时间复杂度消息持久化，对于 TB 级别的数据也能够保证 O(1) 的访问效率</li>
<li>支持批量 <code>读</code> 和 <code>写</code> 数据，并且对于数据进行压缩保证高吞吐</li>
<li>支持消息分区，分布式发送，分布式消费，便于水平扩展 （Scale out），具有很高的并发能力</li>
</ul>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>那为何需要使用消息队列，或者说在什么场景下 Kafka 更加合适</p>
<h3 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a>解耦</h3><p>在大数据，高并发的场景下为了突破性能瓶颈会对系统进行水平扩展和垂直拆分，将一个复杂的系统拆分多个独立，纯净的子系统。数据在各个系统之间流转，但是如果某一个服务处理速度过慢，就会拖累整个链路的性能，形成瓶颈降低整个系统的性能，造成“旱的旱死涝的涝死”的局面。</p>
<p>举个简单例子：在淘宝下单时，交易系统完成扣款，后续会有很多动作：提醒卖家发货，生成卖家工作流，核销优惠券，增加购物积分等等，如果这一步全部写到交易系统的扣款代码之后，很有可能交易系统就会被拖死，下游任何一个环节失败也会导致扣款回滚，并且如果需要添加一个新的动作需要交易去做大量修改，设计肯定是不合理的。实际上交易系统在处理完扣款后会发送一个扣款完成消息，下游接这个消息即可，下游失败不会影响核心流程失败，并且各个系统的边界更加清楚，分层更更加合理。</p>
<h3 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h3><p>如今的应用程序基本都会涉及到多个系统之间的对接，数据在系统之间通过 RPC 进行传递，处理数据的过程失败就会导致数据丢失，除非数据被持久化到磁盘上。而 Kafka 将所有需要流转的数据都 <code>持久化到磁盘上</code> ，保证数据不会丢失。另外还有一个很重要的能力就是保留现场便于后续问题排查跟踪，经历过系统失败但是无法复现的人才会体会到的痛！</p>
<p>为了保证磁盘上的数据不会爆炸式疯涨，Kafka 提供了数据清理，数据压缩等功能，清除处理完成的历史数据。</p>
<h3 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a>扩展性</h3><p>在应用的访问量剧增的情况下，代码优化往往没有直接进行水平扩展来的那么及时。诊断，分析，方案，优化，验证 一系列复杂流程让代码优化看起来只能是一个从长计议的方案。这时止血的方案只能是降级，限流，扩机器 三板斧。Kafka 的扩展性主要就体现在能热扩容，不需要修改参数，不需要修改代码，上机器 -&gt; 注册服务 就完成了扩容。并非所有系统都具备这个像 <code>调节音量旋钮一样简单的提高系统性能</code> 的能力 ，这里会涉及到扩容之前的数据是否会有热点，新节点对集群的同步，流量重分配等等一系列复杂流程。</p>
<h3 id="容灾"><a href="#容灾" class="headerlink" title="容灾"></a>容灾</h3><p>系统的部分组件失败不会影响这个系统的运行，消息队列降低了进程间的耦合度，上游或者下游服务挂掉后不会影响其他系统的运行，在服务重新在线后能够继续处理之前未处理的数据，只是会存在一定的延时但是能够保证 <code>最终业务正确性</code> 。</p>
<h3 id="保序"><a href="#保序" class="headerlink" title="保序"></a>保序</h3><p>强哥：你这瓜保熟吗？哦不，你这队列保序吗？</p>
<p>在大多数场景下，数据处理顺序是至关重要的，顺序错乱很可能导致数据结果错误。除非这个处理过程是无状态的，此时消息只是起到事件触发的作用，触发下游进行计算。Kafka 可以保证分区内部有序而不能保证全局有序。</p>
<h2 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h2><h3 id="架构图"><a href="#架构图" class="headerlink" title="架构图"></a>架构图</h3><p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610274884474-378974bf-6a45-4969-ae07-6763b49d0bba-20210627195830635.png" alt="image.png"></p>
<p>上图是一个典型的 Kafka 架构图，左边为消息生产者(Producer) ，发送消息到一个特定的主题(Topic)，由于 Kafka 的分布式设计每个 Topic 被分成多个分区，因此发送到每个 Topic 的消息会被存储到对应的分区。另外如果 Topic 设置了副本，则每个分区都会有对应的副本。这些 Topic 被不同的消费者(Consumer)订阅，如果两个消费者在同一个消费者组，那么里面的消费者只能订阅一个固定的分区。</p>
<p>用上图的 Topic A 举例， Producer 1 发送消息到 Topic-A ，消息会在存放在 Broker-2 和 Broker-3 的两个分区上，并且由于 Topic-A 开启了分区备份，所以每个分区都会由另外一个节点 Topic-A’ 备份分区数据 。发送到 Broker 的数据会被消费者订阅，由于 Consumer-1 和 Consumer-2 在同一个消费者组中，他们只能消费一个固定分区的消息, Consumer-1 只会接收到 Topic-A Partition-1 的消息，Consumer-2 只会接收到 Topic-A Partition-0 的消息。</p>
<h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h3><p>在 Kafka 集群中的一个 Kafka Server 就是一个 Broker ，生产者将消息投递到 Broker ，Broker 保证消息的 持久化，容灾，准确性等。同时接受消费者的消息订阅，向消费者分发消息。一般来说在生产环境一台 Kafka 服务器就是一个 Broker。</p>
<h3 id="Topic-amp-Partition-amp-Log"><a href="#Topic-amp-Partition-amp-Log" class="headerlink" title="Topic &amp; Partition &amp; Log"></a>Topic &amp; Partition &amp; Log</h3><p>Topic 可以认为是用来存储消息的逻辑概念，可简单认为他是一个 <code>信箱</code> 。每条消息发送的时候都需要指定需要发送到哪个 Topic ，消息被消费的时候也需要指定消费哪个 Topic 中的消息。</p>
<p>Kafka 为了提高可扩展性以及吞吐量，Topic 被分成多个分区 (Partition) ，每个 Partition 对应一个 Log，Log 是一个逻辑概念， 它会对应服务器上一个文件夹，这个文件夹下存放的是这个 Partition 下所有的消息数据和消息索引 。在面对海量数据的时候，为了避免出现巨大文件出现 I/O 瓶颈，Kafka 又将 Log 分为多个 Segment 。每个 Segment 包含 <code>log 文件</code> 和 <code>index 文件</code> 文件命名是以该 Segment 第一条消息的 offset 命名。这样说下来其实还是很绕的直接看下面的架构图，可以仔细留意一下各个部分的标识和数字再结合这段文字，理解起来应该就很轻松了。</p>
<p>另外因为 Kafka 采用顺序 I/O，顺序 I/O 效率非常高，甚至比随机写内存效率更高，这也是 Kafka 高性能的原因之一。<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610266820578-7cf73cbb-805c-448e-9e65-4d1b15998bcc-20210627195838881.png" alt="image.png"></p>
<h3 id="Replication"><a href="#Replication" class="headerlink" title="Replication"></a>Replication</h3><p>在生产环境中，我们一般会开启 Kafka 消息冗余特性，每个 Partition 都有 1 个或多个副本，我们称之为 Replication。当分区只有一个副本的时候，该分区数据只保留了一份。每个分区副本都会选出一个 Leader ， <code>Leader 是所有读写请求的 “接口人”</code> ，其余副本均为 Follower 。Follower 作用有两个：拉取 Leader 的 Log 数据做 <code>备份</code> ，在 Leader 失败后作为候选人 <code>参与 Leader 选举</code> 。</p>
<h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><p>消息产出的源头，通过一定的策略推送到 Topic 的各个分区 。这里所说的推送策略就是消息路由机制，Kafka 内置多种策略可选例如：按照消息 Key ，轮训等等，甚至用户可以写扩展代码来自定义路由策略。</p>
<h3 id="Consumer-amp-Consumer-Group"><a href="#Consumer-amp-Consumer-Group" class="headerlink" title="Consumer &amp; Consumer Group"></a>Consumer &amp; Consumer Group</h3><p><code>消费者(Consumer)</code> 主要工作是从 Broker 拉取消息，进行消费处理。每个消费者维护自己的消费进度，这样的设计有诸多好处，比如：每个消费者进度能够轻松的进行区分，并且可以修改单个消费者的消费位点跳过或者重新消费某些消息，避免了位点信息的集中化管理的单点故障问题。</p>
<p>现在的应用程序大部分为分布式的系统，一个应用有几十台上百台服务器，这些服务器上运行着相同的代码，那么一个消息过来，每台服务器都执行一次消费逻辑，岂不是会造成巨大的问题。</p>
<p>所以 Kafka 引入了一个新的概念： <code>消费者组(Consumer Group)</code> 。我们可以将这些应用的服务器都放到同一个消费者组中，而 Kafka 规定一条消息只能被同一个消费者组中的一个消费者消费，这样就能完美避免分布式情况下的重复消费问题了。上面所说的情况简单来说是希望实现消息被某台服务器独占，也就是 <code>单播</code> 问题。假如我们希望这条消息被广播出去，每台收到这个消息的服务器都做处理，例如发消息做日志清理，这种情况称为 <code>广播</code> , 那我们只需要将每个消费者放到不同的消费者组即可。</p>
<p>Kafka 引入消费者组的概念巧妙解决了单播和广播问题，而没有区分订阅类型，通过一种逻辑概念来屏蔽掉多种订阅实现。</p>
<p>另外在同一个消费者组中的消费者订阅的分区是确定的，只有在消费者组中的消费者有变化的时候才会进行重分配。例如我们有四个分区，三个消费者，就会出现一个消费者订阅两个分区的情况。而三个分区四个消费者就会出现有消费者处于空闲状态，造成浪费，所以一般消费者的数量尽量不要大于 Topic 的分区数。<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610270047474-39a3031a-91ed-41ed-9e96-4c9072be7fb1-20210627195842349.png" alt="image.png"></p>
<h2 id="尾声（唠叨）"><a href="#尾声（唠叨）" class="headerlink" title="尾声（唠叨）"></a>尾声（唠叨）</h2><p>这是我 2021 年的第一篇博客，年底做回顾的时候才知道去年我过的究竟有多么糟糕。既没有输入也没有输出，虽然工作进入一个新的阶段，会越来越忙，但忙不是拒绝成长的借口，必须保证每月一到两本书的输入，一到两周输出一篇优质文章。 <code>最长的路属于一颗孤独的心，与君共勉</code> </p>
<p>下期我会从整体梳理 Kafka 生产者，包括消息发送客户端，发送端数据缓存从源码角度看看其中的设计模式，代码组织技巧。</p>
<p>大家也可以关注下微信公众号哦~</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610289331606-52e03a47-f431-4b20-8b57-6a4cc0f70345-20210627195846896.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/08/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%E6%9E%B6%E6%9E%84%E7%AE%80%E4%BB%8B/" data-id="cmblme38w007mlppv83t5gyqm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka-%E6%8E%A2%E9%99%A9/" rel="tag">Kafka 探险</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Kafka系列文章/Kafka 探险 -  生产者源码分析_核心组件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/01/04/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%20%E7%94%9F%E4%BA%A7%E8%80%85%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" class="article-date">
  <time datetime="2021-01-04T17:20:28.000Z" itemprop="datePublished">2021-01-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Kafka-%E6%8E%A2%E9%99%A9/">Kafka 探险</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2021/01/04/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%20%E7%94%9F%E4%BA%A7%E8%80%85%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/">Kafka 探险 -  生产者源码分析:核心组件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>这个 Kafka 的专题，我会从系统整体架构，设计到代码落地。和大家一起杠源码，学技巧，涨知识。希望大家持续关注一起见证成长！</p>
<p><strong>我相信：技术的道路，十年如一日！十年磨一剑！</strong></p>
</blockquote>
<h2 id="往期文章"><a href="#往期文章" class="headerlink" title="往期文章"></a>往期文章</h2><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/MBvXz5OJypUtJy3BqkRJ1w">Kafka 探险 - 架构简介</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/Vu7EZJl529UVNGOrRZa4jQ">Kafka 探险 - 源码环境搭建</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我们说 Kafka 是一个消息队列，其实更加确切的说：是 Broker 这个核心部件。为何这么说？你会发现我们可以通过控制台、 Java 代码、 C++ 代码、甚至是 Socket 向 Broker 写入消息，只要我们遵从了 Kafka 写入消息的协议，就可以将消息发送到 Kafka 队列中。</p>
<p>用专业一点的话术来说，Kafka 定义了一个应用层的网络协议，只要我们基于传输层构造出符合这个协议的数据，就是合法的 Kafka 消息。<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610854581291-8134c371-cf23-48d4-a48d-be40b19de139-20210627200023451.png" alt="image.png"></p>
<p>所以说我们写入 Kafka 消息的只是一个生产者的客户端，他的形式多种多样，有 Java ，Python，C++ 等多种实现，那么我们每次发消息难道还需要自己去实现这套发送消息的协议么？显然 Kafka 官方已经考虑到这个问题了，为了给我们提供 <code>开箱即用</code> 的消息队列，官方已经帮我们写好了各种语言的优质生产者实现，例如我们今天要讨论的 Java 版本的实现。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>前面提到 Kafka 帮我们实现了各个版本的生产者代码，其实他也可以完全不提供这份代码，因为核心的队列的功能已经实现了，这些客户端的代码也可以完全交由用户自己实现。</p>
<p>那么假如没有官方代码，我们又该实现一些什么功能，有哪些接口，哪些方法，以及如何组织这些代码呢。带着这样的问题我们一起来思考一下！一般对于这种带有数据流转的设计，我会从 <code>由谁产生？</code>  <code>什么数据？</code>  <code>通往哪去？</code>  <code>如何保证通路可靠？</code> 这几个方面来考虑。</p>
<p>消息自然是通过应用程序构造出来并提供给生产者，生产者首先要知道需要将消息发送到哪个 Broker 的哪个 Topic，以及 Topic 的具体 Partition 。那么必然需要配置客户端的  <code>Broker集群地址</code> ，需要发送的 <code>Topic 名称</code> ，以及 <code>消息的分区策略</code> ，是指定到具体的分区还是通过某个 key hash 到不同的分区。</p>
<p>知道了消息要通往哪，还需要知道发送的是什么格式的消息，是字符串还是数字或是被序列化的二进制对象。 <code>消息序列化</code> 将需要消息序列化成字节数组才方便在网络上传输，所以要配置生产者的消息序列化策略，最好是可以通过传递枚举或者类名的方式自动构造序列化器，便于后续序列化过程的扩展。</p>
<p>从上面一篇文章 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI3OTUwNjk2Mg==&mid=2247483681&idx=1&sn=4c05da3526010684bcaea3af9b0edda7&chksm=eb47f85cdc30714ace65fa1eabdb056fec217e55c628d87933ca4341aaac3f6ed6dd0e339e12&token=73482671&lang=zh_CN#rd">《Kafka 探险 - 架构简介》</a> 了解到：消息队列常常用于多个系统之间的异步调用，那么这种调用关系就没有强实时依赖。由于发消息到 Kafka 会产生 <code>网络 I/O</code> ，相对来说比较耗时，那么消息发送这一动作除了同步调用， <code>是否也可以设置为异步，提高生产者的吞吐呢?</code> 。并且大量消息发送场景, 我们可以设置一个窗口，窗口可以是时间维度也可以是消息数量维度，将消息积攒起来批次发送，减少网络 I/O 次数，提高吞吐量。</p>
<p>最后呢为了保证消息可以最大程度的成功发送到 Broker ，我们还需要一些 <code>失败重试机制</code> ，例如失败后放到重试队列中，隔一段时间尝试再次发送。</p>
<h2 id="理清思路"><a href="#理清思路" class="headerlink" title="理清思路"></a>理清思路</h2><p>通过上面的分析，我们会有一个大致的认识，应该会有哪些方法，以及底层的大致的设计会分为哪几个部分。但是不够清楚，不够明晰。</p>
<p>首先总结一下实现客户端的几个要点在于：</p>
<ol>
<li>配置 Broker 基础信息：集群地址、Topic、Partition</li>
<li>消息序列化，通过可扩展的序列化器实现</li>
<li>消息异步写入缓冲区，网络 I/O 线程实现消息发送</li>
<li>消息发送的失败重试机制</li>
</ol>
<p>话不多说，用一张图画出各个核心模块以及他们之间的交互顺序：<img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610872577765-253a8871-3f71-4679-b1fc-c575054ffe4d-20210627200028027.png" alt="image.png"></p>
<p>用户设定 Kafka 集群信息，生产者从 Kafka Broker 上拉取 可用 Kafka 节点、Topic 以及 Partition 对应关系。缓存到生产者成员变量中，如果 Broker 集群有扩容，或者有机器下线需要重新获取这些服务信息。</p>
<p>客户端根据用户设置的序列化器，对消息进行序列化，之后异步的将消息写入到客户端缓冲区。缓冲区内的消息到达一定的数量或者到达一个时间窗口后，网络 I/O 线程将消息从缓冲区取走，发送到 Broker 。</p>
<p>以上就是我对于一个 Kafka 生产者实现的思考，接下来看看官方的代码设计与我们的思路有何差别，他又是为什么这么设计。</p>
<h2 id="官方设计"><a href="#官方设计" class="headerlink" title="官方设计"></a>官方设计</h2><p>其实经过上面的思考和整理，我们的设计已经非常接近  Kafka 的官方设计了，官方的模块拆分的更加细致，功能更加独立。</p>
<h3 id="核心组件"><a href="#核心组件" class="headerlink" title="核心组件"></a>核心组件</h3><p>首先看一眼 KafkaProducer 类中有哪些成员变量，这些变量就是 Producer 的核心组件。</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610875067431-2eb7521c-dccc-4f78-b97c-34a85e1e3d9a-20210627200032362.png" alt="image.png"></p>
<p>其中核心字段的解释如下：</p>
<p><code>clinetId</code> ：标识发送者Id</p>
<p><code>metric</code> ：统计指标</p>
<p><code>partitioner</code> ：分区器作用是决定消息发到哪个分区。有 key 则按照 key 的 hash ，否则使用 roundrobin</p>
<p><code>key/value Serializer</code> ：消息 key/value 序列化器</p>
<p><code>interceptors</code> ：发送之前/后对消息的统一处理</p>
<p><code>maxRequestSize</code> ：可以发送的最大消息，默认值是1M，即影响一个消息 Record 的大小，此值在服务端也是有限制的。</p>
<p><code>maxBlockTimeMs</code> ：buffer满了或者等待metadata信息的，超时的补偿机制</p>
<p><code>accumulator</code> ：累积缓冲器</p>
<p><code>networkClient</code> ：包装的网络层</p>
<p><code>sender</code> ：网络 I/O 线程</p>
<h3 id="发送流程"><a href="#发送流程" class="headerlink" title="发送流程"></a>发送流程</h3><p>发送一条消息的时候，数据又是怎样在这些组件之间进行流转的呢？</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610877888481-03b77de5-ee4f-4675-a1e4-898ae597b4b5-20210627200036002.png" alt="image.png"></p>
<p>Producer调用 send 方法后，在从 Broker 获取的 Metadata 有效情况下，经过拦截器和序列化后，被分区器放到了一个缓冲区的特定位置，缓冲区由一个 ConcurrentHashMap 构成，key 为主题分区，value 是一个 deque 存放消息缓存块。从客户端角度来看如果无需关心发送结果，发送流程就已经结束了。</p>
<p>接下来是独立的Sender线程负责从缓冲中获取足量的数据调用 Network Client 封装层去真正发送数据，这里使用了 Java8 的 NIO 网络模型发送数据。</p>
<p>可以看到整个逻辑的关键点在于 RecordAccumulator 如何进行消息缓存，一般的成熟框架和中间件中都会有一套自己的内存管理机制，比如 Netty 也有一套复杂而又精妙的内存管理抽象层，这里的缓冲区也是一样的道理，主要需要去看看 Kafka 如何去做内存管理。</p>
<p>另外需要关注 Sender 从缓冲里以什么样的逻辑获取数据，来达到尽量少的网络交互发送尽量多的数据。还有网络失败又是如何保证数据的可靠性的。这个地方也是我们的设计和官方实现的差距，对于网络 I/O 的精心优化。</p>
<p>目前的篇幅已经比较长了，为了大家方便阅读理解，本篇主要从和大家一起思考如何设计一个 Kafka Producer 以及官方是如何实现的，我们之间的差距是什么，更需要关注的点是什么。通过自己的思考和对比更加能认识到不足学习到新的点！</p>
<h2 id="尾声（唠叨）"><a href="#尾声（唠叨）" class="headerlink" title="尾声（唠叨）"></a>尾声（唠叨）</h2><p>这篇文章从周内就开始了，后面断断续续每天写了点，只是每天回去的确实有点晚，偶尔还给我整个失眠，精神状态不太好，周五六点多饭都没吃直接回家睡觉了，确实好困，希望下周能休息好。</p>
<p>这周的工作压力也很大，主要是需要推动很多上下游协同，还需要定方案。经常在想怎么交涉？怎么修改方案大家会认同？怎样说服他们？ 是压力也是锻炼，说明这方面欠缺的较多，该补！</p>
<p>下篇文章主要会写 KafkaProducer 的缓存内存管理机制，Meta 信息更新机制，以及网络 I/O 模型的设计。敬请期待~</p>
<p>另外：大家也可以关注下我的微信公众号哦~ 技术分享和个人思考都会第一时间同步！</p>
<p><img src="https://lwen-pic.oss-cn-beijing.aliyuncs.com/1610289331606-52e03a47-f431-4b20-8b57-6a4cc0f70345-20210627200047498.png" alt="image.png"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/04/Kafka%E7%B3%BB%E5%88%97%E6%96%87%E7%AB%A0/Kafka%20%E6%8E%A2%E9%99%A9%20-%20%20%E7%94%9F%E4%BA%A7%E8%80%85%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90_%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6/" data-id="cmblme38y007slppv306a2wo5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kafka-%E6%8E%A2%E9%99%A9/" rel="tag">Kafka 探险</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/2/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Atom/">-Atom</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">-JAVA</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">-Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA/">-Java -虚拟机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java-Web/">-Java Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaWeb/">-JavaWeb</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">-LeetCode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">-Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mac/">-Mac</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MacOS/">-MacOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">-PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">-SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/leetcode/">-leetcode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%85%B6%E4%BB%96/">-其他</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B0%8F%E8%AE%B0/">-小记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7%E7%B1%BB/">-工具类</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">-开发工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">-数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">-数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">-数据结构与算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E6%96%87/">-杂文</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%AE%B0/">-杂记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">-生活</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1/">-算法设计</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">-计算机网络</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/FrontEnd/">FrontEnd</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/">JAVA</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/Java%E5%B7%A5%E5%85%B7%E5%8C%85/">Java工具包</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JAVA/LOG/">LOG</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/JDK-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">JDK 源码分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Kafka-%E6%8E%A2%E9%99%A9/">Kafka 探险</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/LeetCode/">LeetCode</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/MyBatis/">MyBatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mybatis/">Mybatis</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty/">Netty</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Netty-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Netty 源码分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PHP/">PHP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PT%E7%AB%99/">PT站</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shiro/">Shiro</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spark/">Spark</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-Fu/">Spring Fu</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Spring 源码分析</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Spring-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/Spring/">Spring</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringBoot/">SpringBoot</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringCloud/">SpringCloud</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringFu/">SpringFu</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/SpringFu/Spring/">Spring</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/SpringMVC/">SpringMVC</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Tomcat/">Tomcat</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7/">工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B7%A5%E5%85%B7%E9%9B%86/">工具集</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/">开发工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%96%87%E7%AB%A0/">文章</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/Linux/">Linux</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%AE%B0/">杂记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/">生活</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4/">阿里巴巴</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB/%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4/%E5%BC%80%E5%BF%83/">开心</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E5%B0%8F%E8%AE%B0/">生活小记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/">生活感悟</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%A7%86%E9%A2%91%E5%90%8E%E6%9C%9F/">视频后期</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MacOS/" rel="tag">-MacOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CSS/" rel="tag">CSS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/DB-MangoDB/" rel="tag">DB MangoDB</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Filter/" rel="tag">Filter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hibernate/" rel="tag">Hibernate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IO/" rel="tag">IO</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JAVA/" rel="tag">JAVA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDBC/" rel="tag">JDBC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK-%E6%BA%90%E7%A0%81/" rel="tag">JDK 源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JDK-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">JDK 源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JVM-Java-%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">JVM Java 虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-Web/" rel="tag">Java Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E5%B7%A5%E5%85%B7%E5%8C%85/" rel="tag">Java 工具包</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA/" rel="tag">Java 虚拟机</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java8/" rel="tag">Java8</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaWeb/" rel="tag">JavaWeb</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%AD%A6%E4%B9%A0/" rel="tag">Java学习</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java%E5%B7%A5%E5%85%B7/" rel="tag">Java工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Kafka-%E6%8E%A2%E9%99%A9/" rel="tag">Kafka 探险</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac/" rel="tag">Mac</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mybatis/" rel="tag">Mybatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/" rel="tag">PHP,包管理器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PHP-%E5%BE%AE%E4%BF%A1/" rel="tag">PHP,微信</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/" rel="tag">React</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redis-NoSql-%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">Redis NoSql 数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shiro/" rel="tag">Shiro</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spark/" rel="tag">Spark</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sping/" rel="tag">Sping</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring-%E6%BA%90%E7%A0%81/" rel="tag">Spring 源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringFu/" rel="tag">SpringFu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Struts2/" rel="tag">Struts2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vim/" rel="tag">Vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webpack/" rel="tag">Webpack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/" rel="tag">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/log/" rel="tag">log</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oh-my-zsh/" rel="tag">oh-my-zsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsocks/" rel="tag">shadowsocks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/struts2/" rel="tag">struts2</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%B8%BB%E9%A2%98/" rel="tag">主题</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" rel="tag">二叉树</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" rel="tag">动态规划</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7/" rel="tag">工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%B7%A5%E5%85%B7-WebStrom-JetBrains/" rel="tag">工具 WebStrom JetBrains</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" rel="tag">开发工具</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BC%80%E5%BF%83/" rel="tag">开心</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%92%E5%BA%8F/" rel="tag">排序</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F/" rel="tag">数字图像</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%96%87%E7%AB%A0/" rel="tag">文章</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E6%96%87/" rel="tag">杂文</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%AE%B0/" rel="tag">杂记</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81/" rel="tag">源码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" rel="tag">源码分析</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB/" rel="tag">生活</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/" rel="tag">生活感悟</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%99%BE%E9%98%BF/" rel="tag">百阿</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1/" rel="tag">算法设计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%88%E7%AB%AF/" rel="tag">终端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%8C%83%E5%9E%8B/" rel="tag">范型</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%A7%86%E9%A2%91%E5%90%8E%E6%9C%9F/" rel="tag">视频后期</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/" rel="tag">设计模式,模板方法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式,策略设计模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式,组合模式</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A3%85%E9%A5%B0%E8%80%85/" rel="tag">设计模式,装饰者</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85/" rel="tag">设计模式,观察者</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%B4%A3%E4%BB%BB%E9%93%BE/" rel="tag">设计模式,责任链</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%82%E9%85%8D%E5%99%A8/" rel="tag">设计模式,适配器</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%93%BE%E8%A1%A8/" rel="tag">链表</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%BF%E9%87%8C/" rel="tag">阿里</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/" rel="tag">集合框架</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" rel="tag">面向对象</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MacOS/" style="font-size: 10px;">-MacOS</a> <a href="/tags/CSS/" style="font-size: 12px;">CSS</a> <a href="/tags/DB-MangoDB/" style="font-size: 10px;">DB MangoDB</a> <a href="/tags/Docker/" style="font-size: 10px;">Docker</a> <a href="/tags/Filter/" style="font-size: 10px;">Filter</a> <a href="/tags/Hibernate/" style="font-size: 12px;">Hibernate</a> <a href="/tags/IO/" style="font-size: 10px;">IO</a> <a href="/tags/JAVA/" style="font-size: 10px;">JAVA</a> <a href="/tags/JDBC/" style="font-size: 10px;">JDBC</a> <a href="/tags/JDK-%E6%BA%90%E7%A0%81/" style="font-size: 10px;">JDK 源码</a> <a href="/tags/JDK-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 19px;">JDK 源码分析</a> <a href="/tags/JVM-Java-%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 10px;">JVM Java 虚拟机</a> <a href="/tags/Java/" style="font-size: 18px;">Java</a> <a href="/tags/Java-Web/" style="font-size: 10px;">Java Web</a> <a href="/tags/Java-%E5%B7%A5%E5%85%B7%E5%8C%85/" style="font-size: 10px;">Java 工具包</a> <a href="/tags/Java-%E8%99%9A%E6%8B%9F%E6%9C%BA/" style="font-size: 11px;">Java 虚拟机</a> <a href="/tags/Java8/" style="font-size: 14px;">Java8</a> <a href="/tags/JavaScript/" style="font-size: 12px;">JavaScript</a> <a href="/tags/JavaWeb/" style="font-size: 10px;">JavaWeb</a> <a href="/tags/Java%E5%AD%A6%E4%B9%A0/" style="font-size: 10px;">Java学习</a> <a href="/tags/Java%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">Java工具</a> <a href="/tags/Kafka-%E6%8E%A2%E9%99%A9/" style="font-size: 12px;">Kafka 探险</a> <a href="/tags/LeetCode/" style="font-size: 17px;">LeetCode</a> <a href="/tags/Linux/" style="font-size: 11px;">Linux</a> <a href="/tags/Mac/" style="font-size: 10px;">Mac</a> <a href="/tags/MyBatis/" style="font-size: 15px;">MyBatis</a> <a href="/tags/Mybatis/" style="font-size: 10px;">Mybatis</a> <a href="/tags/PHP-%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/" style="font-size: 10px;">PHP,包管理器</a> <a href="/tags/PHP-%E5%BE%AE%E4%BF%A1/" style="font-size: 10px;">PHP,微信</a> <a href="/tags/React/" style="font-size: 10px;">React</a> <a href="/tags/Redis-NoSql-%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 10px;">Redis NoSql 数据库</a> <a href="/tags/Shiro/" style="font-size: 10px;">Shiro</a> <a href="/tags/Spark/" style="font-size: 14px;">Spark</a> <a href="/tags/Sping/" style="font-size: 10px;">Sping</a> <a href="/tags/Spring/" style="font-size: 17px;">Spring</a> <a href="/tags/Spring-%E6%BA%90%E7%A0%81/" style="font-size: 12px;">Spring 源码</a> <a href="/tags/SpringBoot/" style="font-size: 20px;">SpringBoot</a> <a href="/tags/SpringCloud/" style="font-size: 12px;">SpringCloud</a> <a href="/tags/SpringFu/" style="font-size: 11px;">SpringFu</a> <a href="/tags/SpringMVC/" style="font-size: 12px;">SpringMVC</a> <a href="/tags/Struts2/" style="font-size: 10px;">Struts2</a> <a href="/tags/Vim/" style="font-size: 10px;">Vim</a> <a href="/tags/Web/" style="font-size: 10px;">Web</a> <a href="/tags/Webpack/" style="font-size: 10px;">Webpack</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/log/" style="font-size: 10px;">log</a> <a href="/tags/oh-my-zsh/" style="font-size: 10px;">oh-my-zsh</a> <a href="/tags/shadowsocks/" style="font-size: 10px;">shadowsocks</a> <a href="/tags/struts2/" style="font-size: 11px;">struts2</a> <a href="/tags/%E4%B8%BB%E9%A2%98/" style="font-size: 10px;">主题</a> <a href="/tags/%E4%BA%8C%E5%8F%89%E6%A0%91/" style="font-size: 11px;">二叉树</a> <a href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/" style="font-size: 14px;">动态规划</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size: 11px;">多线程</a> <a href="/tags/%E5%B7%A5%E5%85%B7/" style="font-size: 12px;">工具</a> <a href="/tags/%E5%B7%A5%E5%85%B7-WebStrom-JetBrains/" style="font-size: 10px;">工具 WebStrom JetBrains</a> <a href="/tags/%E5%BC%80%E5%8F%91%E5%B7%A5%E5%85%B7/" style="font-size: 10px;">开发工具</a> <a href="/tags/%E5%BC%80%E5%BF%83/" style="font-size: 11px;">开心</a> <a href="/tags/%E6%8E%92%E5%BA%8F/" style="font-size: 11px;">排序</a> <a href="/tags/%E6%95%B0%E5%AD%97%E5%9B%BE%E5%83%8F/" style="font-size: 10px;">数字图像</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="font-size: 15px;">数据库</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" style="font-size: 16px;">数据结构</a> <a href="/tags/%E6%96%87%E7%AB%A0/" style="font-size: 10px;">文章</a> <a href="/tags/%E6%9D%82%E6%96%87/" style="font-size: 11px;">杂文</a> <a href="/tags/%E6%9D%82%E8%AE%B0/" style="font-size: 13px;">杂记</a> <a href="/tags/%E6%BA%90%E7%A0%81/" style="font-size: 14px;">源码</a> <a href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" style="font-size: 10px;">源码分析</a> <a href="/tags/%E7%94%9F%E6%B4%BB/" style="font-size: 18px;">生活</a> <a href="/tags/%E7%94%9F%E6%B4%BB%E6%84%9F%E6%82%9F/" style="font-size: 11px;">生活感悟</a> <a href="/tags/%E7%99%BE%E9%98%BF/" style="font-size: 11px;">百阿</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 10px;">算法</a> <a href="/tags/%E7%AE%97%E6%B3%95%E8%AE%BE%E8%AE%A1/" style="font-size: 13px;">算法设计</a> <a href="/tags/%E7%BB%88%E7%AB%AF/" style="font-size: 10px;">终端</a> <a href="/tags/%E8%8C%83%E5%9E%8B/" style="font-size: 10px;">范型</a> <a href="/tags/%E8%A7%86%E9%A2%91%E5%90%8E%E6%9C%9F/" style="font-size: 12px;">视频后期</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95/" style="font-size: 10px;">设计模式,模板方法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%AD%96%E7%95%A5%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式,策略设计模式</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E7%BB%84%E5%90%88%E6%A8%A1%E5%BC%8F/" style="font-size: 10px;">设计模式,组合模式</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A3%85%E9%A5%B0%E8%80%85/" style="font-size: 10px;">设计模式,装饰者</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%A7%82%E5%AF%9F%E8%80%85/" style="font-size: 10px;">设计模式,观察者</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%B4%A3%E4%BB%BB%E9%93%BE/" style="font-size: 10px;">设计模式,责任链</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E9%80%82%E9%85%8D%E5%99%A8/" style="font-size: 10px;">设计模式,适配器</a> <a href="/tags/%E9%93%BE%E8%A1%A8/" style="font-size: 11px;">链表</a> <a href="/tags/%E9%98%BF%E9%87%8C/" style="font-size: 11px;">阿里</a> <a href="/tags/%E9%9B%86%E5%90%88%E6%A1%86%E6%9E%B6/" style="font-size: 11px;">集合框架</a> <a href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/" style="font-size: 11px;">面向对象</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/06/">June 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/05/">May 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">March 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">February 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/06/07/Java%20SE/Guava%20Cache%20%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/07/11/Spring/SpringFu%20DSL%20%E8%AE%BE%E8%AE%A1%E6%80%9D%E6%83%B3/">SpringFu DSL 设计思想</a>
          </li>
        
          <li>
            <a href="/2021/07/11/Spring/SpringFu%20%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/">SpringFu 启动流程</a>
          </li>
        
          <li>
            <a href="/2021/07/10/Spring/%E7%94%A8%E5%87%BD%E6%95%B0%E5%86%99%20Spring%20%E9%A1%B9%E7%9B%AE%E4%BD%A0%E8%A7%81%E8%BF%87%E4%B9%88%20--SpringFu/">用函数写 Bean 你见过么</a>
          </li>
        
          <li>
            <a href="/2021/06/27/Tomcat/%E6%8F%AD%E7%A7%98%20Tomcat%EF%BC%88%E4%B8%80%EF%BC%89%20-%20%E5%90%AF%E5%8A%A8/">揭秘 Tomcat - 启动</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2025 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>